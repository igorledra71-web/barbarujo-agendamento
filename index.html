<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BARBARUJO ‚Ä¢ Agendamento</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,sans-serif}
body{background:#0f0f0f;color:#fff}
header{background:#111;padding:18px;text-align:center;font-size:26px;font-weight:700;border-bottom:2px solid #222;cursor:pointer}
.container{max-width:900px;margin:auto;padding:18px}
.card{background:#181818;border-radius:14px;padding:18px;margin-bottom:16px;box-shadow:0 0 12px rgba(0,0,0,.4)}
.title{font-size:18px;margin-bottom:12px;font-weight:600}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.btn{background:#d4af37;border:none;padding:14px;border-radius:10px;font-weight:600;cursor:pointer;width:100%}
.btn-outline{background:transparent;border:2px solid #d4af37;color:#d4af37;padding:12px;border-radius:10px;width:100%;cursor:pointer}
input,select{width:100%;padding:12px;border-radius:8px;border:none;margin-top:6px}
.slot{background:#222;padding:10px;border-radius:8px;text-align:center;cursor:pointer}
.slot.booked{background:#401616;opacity:.5;pointer-events:none}
.slot.selected{outline:3px solid #d4af37}
.hidden{display:none}
.badge{background:#d4af37;color:#000;padding:4px 8px;border-radius:6px;font-size:12px}
footer{text-align:center;padding:30px;opacity:.6;font-size:12px}
</style>
</head>

<body>

<header id="topo">üíà BARBARUJO</header>

<div class="container">

<div id="telaCliente">

<div class="card">
<div class="title">Escolha o servi√ßo</div>
<div id="listaServicos" class="grid"></div>
</div>

<div id="cardBarbeiro" class="card hidden">
<div class="title">Escolha o barbeiro</div>
<div id="listaBarbeiros" class="grid"></div>
</div>

<div id="cardData" class="card hidden">
<div class="title">Escolha a data</div>
<input type="date" id="dataEscolhida">
</div>

<div id="cardHorarios" class="card hidden">
<div class="title">Hor√°rios dispon√≠veis</div>
<div id="listaHorarios" class="grid"></div>
</div>

<div id="cardCliente" class="card hidden">
<div class="title">Seus dados</div>
<input id="clienteNome" placeholder="Nome">
<input id="clienteFone" placeholder="WhatsApp">
<button class="btn" id="btnConfirmar">Confirmar Agendamento</button>
</div>

</div>
<div id="telaAdmin" class="hidden">

<div class="card">
<div class="title">Painel Administrador</div>
<button class="btn-outline" id="btnLogout">Sair do Admin</button>
</div>

<div class="card">
<div class="title">Servi√ßos</div>

<label>Nome</label>
<input id="novoServicoNome">

<label>Pre√ßo</label>
<input id="novoServicoPreco">

<button class="btn" id="btnAddServico">Adicionar servi√ßo</button>

<div id="adminServicos"></div>
</div>

<div class="card">
<div class="title">Barbeiros</div>

<label>Nome barbeiro</label>
<input id="novoBarbeiro">

<button class="btn" id="btnAddBarbeiro">Adicionar barbeiro</button>

<div id="adminBarbeiros"></div>
</div>

<div class="card">
<div class="title">Configura√ß√£o de Funcionamento</div>

<label>Abertura</label>
<input type="time" id="cfgAbertura">

<label>Fechamento</label>
<input type="time" id="cfgFechamento">

<label>Intervalo (minutos)</label>
<select id="cfgIntervalo">
<option>15</option>
<option>30</option>
<option>45</option>
<option>60</option>
</select>

<button class="btn" id="btnSalvarCfg">Salvar Configura√ß√£o</button>
</div>

<div class="card">
<div class="title">Ferramentas Premium</div>

<button class="btn" id="btnExportarDia">Copiar agenda do dia</button>
<button class="btn" id="btnSetup">Setup r√°pido white-label</button>
<button class="btn" id="btnDemo">Popular modo demonstra√ß√£o</button>
</div>

<div class="card">
<div class="title">Agendamentos</div>
<div id="listaAgendamentos"></div>
</div>

</div>

<footer>
Sistema Premium Multi-Barbeiro ‚Ä¢ BARBARUJO
</footer>
<!-- FIREBASE COMPAT -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>

const firebaseConfig = {
apiKey: "AIzaSyBDffb23AqSOoT-8Z94Ao9leB5nTSdIv78",
authDomain: "agenda-barbarujo.firebaseapp.com",
databaseURL: "https://agenda-barbarujo-default-rtdb.firebaseio.com/",
projectId: "agenda-barbarujo",
storageBucket: "agenda-barbarujo.firebasestorage.app",
messagingSenderId: "735138068544",
appId: "1:735138068544:web:5a1273bd8be9ef7ab487a5"
}

firebase.initializeApp(firebaseConfig)
const db = firebase.database()

// caminhos base
const DB = {
servicos: db.ref("barbarujo/servicos"),
barbeiros: db.ref("barbarujo/barbeiros"),
config: db.ref("barbarujo/config"),
ag: db.ref("barbarujo/agendamentos")
}

</script>
<script>

// =========================
// ESTADO GLOBAL
// =========================

let servicos = []
let barbeiros = []
let config = {
abertura: "08:00",
fechamento: "20:00",
intervalo: 30
}
let agendamentos = []

let servicoSel = null
let barbeiroSel = null
let horaSel = null

let NOME_BARBEARIA = "BARBARUJO"
let WHATS_BARBEARIA = "5599999999999"

const ADMIN_SENHA = "barbarujo123"

// =========================
// HELPERS
// =========================

function hojeISO(){
return new Date().toISOString().split("T")[0]
}

dataEscolhida.min = hojeISO()

clienteFone.addEventListener("input",()=>{
clienteFone.value = clienteFone.value.replace(/\D/g,"").slice(0,11)
})

// =========================
// RENDER SERVI√áOS CLIENTE
// =========================

function renderServicos(){
listaServicos.innerHTML = ""

servicos.forEach(s=>{
let b = document.createElement("button")
b.className = "btn"
b.innerHTML = `${s.nome}<br><span class="badge">R$ ${s.preco}</span>`

b.onclick = ()=>{
servicoSel = s
cardBarbeiro.classList.remove("hidden")
renderBarbeiros()
}

listaServicos.appendChild(b)
})
}

// =========================
// RENDER BARBEIROS CLIENTE
// =========================

function renderBarbeiros(){
listaBarbeiros.innerHTML = ""

barbeiros.forEach(n=>{
let b = document.createElement("button")
b.className = "btn-outline"
b.innerText = n

b.onclick = ()=>{
barbeiroSel = n
cardData.classList.remove("hidden")
}

listaBarbeiros.appendChild(b)
})
}

// =========================
// RENDER ADMIN SERVI√áOS
// =========================

function renderAdminServicos(){
adminServicos.innerHTML = ""

servicos.forEach((s,i)=>{
let div = document.createElement("div")
div.className = "card"
div.innerHTML = `
<b>${s.nome}</b> ‚Äî R$ ${s.preco}
<br><br>
<button class="btn-outline" onclick="removerServico(${i})">Remover</button>
`
adminServicos.appendChild(div)
})
}

// =========================
// RENDER ADMIN BARBEIROS
// =========================

function renderAdminBarbeiros(){
adminBarbeiros.innerHTML = ""

barbeiros.forEach((b,i)=>{
let div = document.createElement("div")
div.className = "card"
div.innerHTML = `
<b>${b}</b>
<br><br>
<button class="btn-outline" onclick="removerBarbeiro(${i})">Remover</button>
`
adminBarbeiros.appendChild(div)
})
}

// =========================
// RENDER ADMIN AGENDAMENTOS
// =========================

function renderAdminAgendamentos(){

listaAgendamentos.innerHTML = ""

agendamentos
.sort((a,b)=>(a.data+a.hora).localeCompare(b.data+b.hora))
.forEach((a,i)=>{

let div = document.createElement("div")
div.className = "card"

div.innerHTML = `
<span class="badge">${a.data} ${a.hora}</span>
<br><br>
<b>${a.servico}</b> ‚Äî R$ ${a.preco}
<br>
Barbeiro: ${a.barbeiro}
<br>
Cliente: ${a.cliente}
<br>
Whats: ${a.fone}
`

listaAgendamentos.appendChild(div)

})
}

</script>
<script>

// =========================
// DATA ‚Üí GERAR HOR√ÅRIOS
// =========================

dataEscolhida.onchange = ()=>{
if(!barbeiroSel){
alert("Escolha o barbeiro primeiro")
return
}
gerarHorarios()
cardHorarios.classList.remove("hidden")
}

// =========================
// GERAR HOR√ÅRIOS DIN√ÇMICO
// =========================

function gerarHorarios(){

listaHorarios.innerHTML = ""
horaSel = null

if(!config.abertura || !config.fechamento) return

let [ha,ma] = config.abertura.split(":").map(Number)
let [hf,mf] = config.fechamento.split(":").map(Number)

let inicio = ha*60 + ma
let fim = hf*60 + mf
let intervalo = Number(config.intervalo || 30)

for(let t=inicio; t<fim; t+=intervalo){

let h = Math.floor(t/60).toString().padStart(2,"0")
let m = (t%60).toString().padStart(2,"0")
let hora = h+":"+m

let div = document.createElement("div")
div.className = "slot"
div.innerText = hora

// =========================
// BLOQUEIO POR BARBEIRO
// =========================

let ocupado = agendamentos.find(a=>
a.data === dataEscolhida.value &&
a.hora === hora &&
a.barbeiro === barbeiroSel
)

if(ocupado){
div.classList.add("booked")
}

// =========================
// SELE√á√ÉO VISUAL
// =========================

div.onclick = ()=>{

if(div.classList.contains("booked")) return

document.querySelectorAll(".slot")
.forEach(s=>s.classList.remove("selected"))

div.classList.add("selected")
horaSel = hora
cardCliente.classList.remove("hidden")

}

listaHorarios.appendChild(div)

}

}

// =========================
// AUTO ATUALIZA SE DB MUDAR
// =========================

DB.ag.on("child_added", ()=>{
if(cardHorarios && !cardHorarios.classList.contains("hidden")){
gerarHorarios()
}
})

DB.ag.on("child_removed", ()=>{
if(cardHorarios && !cardHorarios.classList.contains("hidden")){
gerarHorarios()
}
})

</script>
<script>

// =========================
// TRAVA DUPLO CLIQUE
// =========================

let salvando = false

// =========================
// WHATS CONFIRMA√á√ÉO CLIENTE
// =========================

function enviarWhatsConfirmacao(ag){

let msg =
`üíà ${NOME_BARBEARIA} ‚Äî Agendamento Confirmado

Servi√ßo: ${ag.servico}
Barbeiro: ${ag.barbeiro}
Data: ${ag.data}
Hora: ${ag.hora}
Valor: R$ ${ag.preco}

Chegue 5 minutos antes.`

let url = "https://wa.me/55" +
ag.fone.replace(/\D/g,"") +
"?text=" + encodeURIComponent(msg)

window.open(url,"_blank")
}

// =========================
// RESET FLUXO CLIENTE
// =========================

function resetFluxo(){

servicoSel = null
barbeiroSel = null
horaSel = null

cardBarbeiro.classList.add("hidden")
cardData.classList.add("hidden")
cardHorarios.classList.add("hidden")
cardCliente.classList.add("hidden")

clienteNome.value = ""
clienteFone.value = ""
dataEscolhida.value = ""

}

// =========================
// CONFIRMAR AGENDAMENTO
// =========================

btnConfirmar.onclick = async ()=>{

if(salvando) return
salvando = true

if(!servicoSel || !barbeiroSel || !horaSel){
alert("Selecione servi√ßo, barbeiro e hor√°rio")
salvando = false
return
}

if(!clienteNome.value || !clienteFone.value){
alert("Preencha seus dados")
salvando = false
return
}

// =========================
// CHECAGEM CONFLITO REAL DB
// =========================

let snap = await DB.ag
.orderByChild("data")
.equalTo(dataEscolhida.value)
.get()

let conflito = false

snap.forEach(c=>{
let a = c.val()
if(a.hora === horaSel && a.barbeiro === barbeiroSel){
conflito = true
}
})

if(conflito){
alert("Hor√°rio acabou de ser ocupado ‚Äî escolha outro")
gerarHorarios()
salvando = false
return
}

// =========================
// SALVAR NO FIREBASE
// =========================

let ag = {
servico: servicoSel.nome,
preco: servicoSel.preco,
barbeiro: barbeiroSel,
data: dataEscolhida.value,
hora: horaSel,
cliente: clienteNome.value,
fone: clienteFone.value,
ts: Date.now()
}

await DB.ag.push(ag)

// =========================
// WHATS AUTO
// =========================

setTimeout(()=> enviarWhatsConfirmacao(ag), 700)

alert("Agendamento confirmado üíà")

resetFluxo()
salvando = false

}

// =========================
// BOT√ÉO FALAR BARBEARIA
// =========================

let btnZap = document.createElement("button")
btnZap.className = "btn"
btnZap.innerText = "Falar com a barbearia"

btnZap.onclick = ()=>{
window.open("https://wa.me/" + WHATS_BARBEARIA)
}

document.querySelector(".container").appendChild(btnZap)

</script>
<script>

// =========================
// LOGIN ADMIN
// =========================

topo.ondblclick = ()=>{
let s = prompt("Senha administrador:")
if(s === ADMIN_SENHA){
telaCliente.classList.add("hidden")
telaAdmin.classList.remove("hidden")
}else{
alert("Senha incorreta")
}
}

btnLogout.onclick = ()=>{
telaAdmin.classList.add("hidden")
telaCliente.classList.remove("hidden")
}

// =========================
// FIREBASE SYNC ‚Äî SERVI√áOS
// =========================

DB.servicos.on("value", snap=>{
if(snap.exists()){
servicos = Object.values(snap.val())
}else{
DB.servicos.set([
{nome:"Corte",preco:40},
{nome:"Barba",preco:30},
{nome:"Corte + Barba",preco:65}
])
}
renderServicos()
renderAdminServicos()
})

// =========================
// FIREBASE SYNC ‚Äî BARBEIROS
// =========================

DB.barbeiros.on("value", snap=>{
if(snap.exists()){
barbeiros = Object.values(snap.val())
}else{
DB.barbeiros.set(["Pedro","Lucas"])
}
renderAdminBarbeiros()
})

// =========================
// FIREBASE SYNC ‚Äî CONFIG
// =========================

DB.config.on("value", snap=>{
if(snap.exists()){
config = snap.val()
cfgAbertura.value = config.abertura
cfgFechamento.value = config.fechamento
cfgIntervalo.value = config.intervalo
}else{
DB.config.set(config)
}
})

// =========================
// FIREBASE SYNC ‚Äî AGENDAMENTOS
// =========================

DB.ag.on("value", snap=>{
agendamentos = snap.exists() ? Object.values(snap.val()) : []
renderAdminAgendamentos()
})

// =========================
// ADMIN ‚Äî SERVI√áOS CRUD
// =========================

btnAddServico.onclick = ()=>{
if(!novoServicoNome.value || !novoServicoPreco.value) return

servicos.push({
nome: novoServicoNome.value,
preco: Number(novoServicoPreco.value)
})

DB.servicos.set(servicos)

novoServicoNome.value=""
novoServicoPreco.value=""
}

function removerServico(i){
servicos.splice(i,1)
DB.servicos.set(servicos)
}

// =========================
// ADMIN ‚Äî BARBEIROS CRUD
// =========================

btnAddBarbeiro.onclick = ()=>{
if(!novoBarbeiro.value) return

barbeiros.push(novoBarbeiro.value)
DB.barbeiros.set(barbeiros)
novoBarbeiro.value=""
}

function removerBarbeiro(i){
barbeiros.splice(i,1)
DB.barbeiros.set(barbeiros)
}

// =========================
// ADMIN ‚Äî CONFIG SALVAR
// =========================

btnSalvarCfg.onclick = ()=>{
config = {
abertura: cfgAbertura.value,
fechamento: cfgFechamento.value,
intervalo: Number(cfgIntervalo.value)
}
DB.config.set(config)
alert("Configura√ß√£o salva")
}

// =========================
// EXPORTAR AGENDA DO DIA
// =========================

btnExportarDia.onclick = ()=>{

let hoje = hojeISO()

let lista = agendamentos.filter(a=>a.data === hoje)

let txt = `AGENDA ${NOME_BARBEARIA} ‚Äî ${hoje}\n\n`

lista.forEach(a=>{
txt +=
`${a.hora} ‚Äî ${a.servico}
Barbeiro: ${a.barbeiro}
Cliente: ${a.cliente}
Whats: ${a.fone}

`
})

navigator.clipboard.writeText(txt)
alert("Agenda copiada")
}

</script>
<script>

// =========================
// WHITE LABEL ‚Äî NOME DIN√ÇMICO
// =========================

function aplicarNome(){
topo.innerText = "üíà " + NOME_BARBEARIA
document.title = NOME_BARBEARIA + " ‚Ä¢ Agendamento"
}

aplicarNome()

// =========================
// SETUP R√ÅPIDO WHITE LABEL
// =========================

btnSetup.onclick = ()=>{

let nome = prompt("Nome da barbearia:")
if(nome){
NOME_BARBEARIA = nome.toUpperCase()
}

let zap = prompt("WhatsApp da barbearia (DDD + n√∫mero):")
if(zap){
WHATS_BARBEARIA = "55" + zap.replace(/\D/g,"")
}

aplicarNome()

alert("Setup conclu√≠do üíà")

}

// =========================
// MODO DEMONSTRA√á√ÉO VENDEDOR
// =========================

btnDemo.onclick = ()=>{

let hoje = hojeISO()

servicos = [
{nome:"Corte",preco:45},
{nome:"Barba",preco:30},
{nome:"Combo",preco:70}
]

barbeiros = ["Carlos","Andr√©","Marcos"]

DB.servicos.set(servicos)
DB.barbeiros.set(barbeiros)

DB.ag.push({
servico:"Corte",
preco:45,
barbeiro:"Carlos",
data:hoje,
hora:"10:00",
cliente:"Cliente Demo",
fone:"11999999999",
ts:Date.now()
})

alert("Modo demonstra√ß√£o carregado")
}

// =========================
// INSTALAR COMO APP (PWA)
// =========================

let deferredPrompt = null

window.addEventListener("beforeinstallprompt", e=>{
e.preventDefault()
deferredPrompt = e
})

function instalarApp(){
if(deferredPrompt){
deferredPrompt.prompt()
}
}

// bot√£o instalar
let btnInstalar = document.createElement("button")
btnInstalar.className = "btn"
btnInstalar.innerText = "Instalar como App"
btnInstalar.onclick = instalarApp

document.querySelector(".container").appendChild(btnInstalar)

// =========================
// LOG FINAL
// =========================

console.log("üíà BARBARUJO PREMIUM carregado")
console.log("Multi-barbeiro ativo")
console.log("Firebase realtime ativo")
console.log("Sistema pronto para venda")

</script>

</body>
</html>
