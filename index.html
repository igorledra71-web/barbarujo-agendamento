<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>BARBARUJO ‚Ä¢ Agendamento</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e0e0e">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">

<style>

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:Poppins,sans-serif;
-webkit-user-select:none;
user-select:none;
-webkit-touch-callout:none;
}

html,body{
background:#0e0e0e;
color:#fff;
height:100%;
}

/* ===== HEADER ===== */

header{
background:#111;
padding:18px 16px;
text-align:center;
font-size:22px;
font-weight:800;
border-bottom:1px solid #222;
position:sticky;
top:0;
z-index:50;
}

/* ===== BOT√ÉO VOLTAR GLOBAL ===== */

.btn-back{
position:fixed;
left:12px;
top:12px;
width:44px;
height:44px;
border-radius:12px;
background:#1b1b1b;
border:1px solid #2a2a2a;
display:flex;
align-items:center;
justify-content:center;
font-size:20px;
z-index:60;
cursor:pointer;
}

/* ===== CONTAINER ===== */

.container{
max-width:1000px;
margin:auto;
padding:10px 16px 90px 16px;
display:none;
}

/* ===== CARDS ===== */

.card{
background:#181818;
border-radius:18px;
padding:22px;
margin-bottom:22px;
box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.card-sub{
background:#141414;
border:1px solid #262626;
}

/* ===== GRID ===== */

.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:14px;
}

/* ===== BUTTONS ===== */

.btn{
background:linear-gradient(135deg,#e7c35a,#d4af37);
border:none;
padding:16px;
border-radius:14px;
font-weight:800;
width:100%;
cursor:pointer;
color:#000;
font-size:15px;
}

.btn-outline{
background:transparent;
border:2px solid #d4af37;
color:#d4af37;
padding:14px;
border-radius:14px;
width:100%;
cursor:pointer;
font-weight:700;
}

.btn-dark{
background:#232323;
border:1px solid #333;
color:#fff;
}

.btn-danger{
background:#3a1f1f;
border:2px solid #6b2c2c;
color:#ffb3b3;
}

/* ===== INPUTS ===== */

input,select{
width:100%;
padding:14px;
border-radius:12px;
border:none;
margin-top:8px;
margin-bottom:12px;
color:#000;
font-size:15px;
}

/* ===== SLOT ===== */

.slot{
background:#222;
padding:14px;
border-radius:12px;
text-align:center;
cursor:pointer;
font-weight:700;
}

.slot.booked{
background:#402020;
opacity:.45;
pointer-events:none;
}

.slot.selected{
outline:3px solid #d4af37;
background:#2c2612;
}

/* ===== BADGE ===== */

.badge{
background:#d4af37;
color:#000;
padding:5px 10px;
border-radius:999px;
font-size:12px;
font-weight:800;
}

/* ===== VALOR PREMIUM ===== */

.preco{
font-size:22px;
font-weight:900;
letter-spacing:.5px;
background:linear-gradient(180deg,#ffe08a,#d4af37);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
text-shadow:0 2px 10px rgba(212,175,55,.25);
margin-top:6px;
}

/* ===== SPLASH ===== */

.splash{
position:fixed;
inset:0;
background:#0e0e0e;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
z-index:9999;
padding:20px;
text-align:center;
}

.splash-logo{
width:72vw;
max-width:460px;
min-width:240px;
margin-bottom:18px;
border-radius:26px;
box-shadow:0 0 60px rgba(0,0,0,.85);
transform:translateX(-6%);
}

/* ===== ADMIN FAB ===== */

.admin-fab{
position:fixed;
top:14px;
right:14px;
width:52px;
height:52px;
border-radius:50%;
background:linear-gradient(135deg,#e7c35a,#d4af37);
color:#000;
display:flex;
align-items:center;
justify-content:center;
font-size:22px;
font-weight:900;
z-index:70;
cursor:pointer;
}

/* ===== STEP ===== */

.step{
font-size:11px;
opacity:.6;
margin-bottom:6px;
letter-spacing:.5px;
}

.hidden{display:none}

</style>
</head>
<body>

<div id="btnBack" class="btn-back hidden">‚Üê</div>
<div id="btnAdminFab" class="admin-fab">‚öôÔ∏è</div>

<div id="telaSplash" class="splash">

<img src="logo.png" class="splash-logo">

<h1 style="font-size:34px;margin-bottom:10px">
üíà BARBARUJO
</h1>

<div style="opacity:.8;margin-bottom:18px;line-height:1.5">
Hor√°rio de atendimento<br><br>
Seg‚ÄìSex<br>
09:00‚Äì12:00 ‚Ä¢ 14:00‚Äì19:00<br><br>
S√°bado 09:00‚Äì17:00<br>
Domingo ‚Äî Fechado
</div>

<button id="btnEntrar" class="btn" style="max-width:360px">
Agendar hor√°rio
</button>

<button id="btnModoBarbeiro"
class="btn btn-dark"
style="max-width:360px;margin-top:10px">
Sou barbeiro
</button>

</div>

<header id="topo">üíà BARBARUJO</header>

<div class="container">
<!-- ===================================================== -->
<!-- ===================== CLIENTE ======================= -->
<!-- ===================================================== -->

<div id="telaCliente">

<div class="card" id="cardServico">
<div class="step">PASSO 1</div>
<h3>Escolha o servi√ßo</h3>
<div id="listaServicos" class="grid"></div>
</div>

<div id="cardBarbeiro" class="card hidden">
<div class="step">PASSO 2</div>
<h3>Escolha o barbeiro</h3>
<div id="listaBarbeiros" class="grid"></div>
</div>

<div id="cardData" class="card hidden">
<div class="step">PASSO 3</div>
<h3>Escolha o dia</h3>

<select id="dataEscolhida"></select>

<button id="btnConfirmarData" class="btn-dark btn">
Ver hor√°rios deste dia
</button>
</div>

<div id="cardHorarios" class="card hidden">
<div class="step">PASSO 4</div>
<h3>Escolha o hor√°rio</h3>
<div id="listaHorarios" class="grid"></div>
</div>

<div id="cardCliente" class="card hidden">

<div class="step">PASSO 5</div>
<h3>Confirmar reserva</h3>

<div id="resumoEscolha"></div>

<input id="clienteNome" placeholder="Nome">
<input id="clienteFone" placeholder="WhatsApp">

<button id="btnReservar" class="btn">
Reservar hor√°rio
</button>

<button id="btnConfirmar" class="btn-outline hidden">
Confirmar agendamento
</button>

</div>

</div>

<!-- ===================================================== -->
<!-- =================== MODO BARBEIRO =================== -->
<!-- ===================================================== -->

<div id="telaBarbeiro" class="hidden">

<div class="card">
<h3>Modo Barbeiro</h3>

<select id="barbeiroModoSel"></select>

<input type="date" id="barbeiroModoData">

<button id="btnVerAgendaBarbeiro" class="btn">
Ver minha agenda
</button>

<button id="btnVoltarCliente" class="btn-outline">
Voltar
</button>

</div>

<div class="card">
<h3>Meus clientes do dia</h3>
<div id="listaBarbeiroAgenda"></div>
</div>

</div>

<!-- ===================================================== -->
<!-- ======================= ADMIN ======================= -->
<!-- ===================================================== -->

<div id="telaAdmin" class="hidden">

<div class="card card-sub">
<h3>Painel Administrador</h3>
<button id="btnLogout" class="btn-outline">Sair do painel</button>
</div>

<!-- ===== SERVI√áOS ===== -->

<div class="card">
<h3>Servi√ßos</h3>

<input id="novoServicoNome" placeholder="Nome do servi√ßo">
<input id="novoServicoPreco" placeholder="Pre√ßo">

<button id="btnAddServico" class="btn">
Adicionar servi√ßo
</button>

<div id="adminServicos"></div>
</div>

<!-- ===== BARBEIROS ===== -->

<div class="card">
<h3>Barbeiros</h3>

<input id="novoBarbeiro" placeholder="Nome do barbeiro">

<button id="btnAddBarbeiro" class="btn">
Adicionar barbeiro
</button>

<div id="adminBarbeiros"></div>
</div>

<!-- ===== WHATS LOJA ===== -->

<div class="card card-sub">
<h3>WhatsApp da barbearia</h3>

<input id="cfgWhats" placeholder="5599999999999">

<button id="btnSalvarWhats" class="btn">
Salvar WhatsApp da loja
</button>
</div>

<!-- ===== DISPONIBILIDADE ===== -->

<div class="card">

<h3>Disponibilidade por barbeiro</h3>

<select id="adminBarbeiroSel"></select>
<input type="date" id="adminDataPick">

<button id="btnGerarSlots" class="btn-dark btn">
Gerar hor√°rios
</button>

<div id="adminSlotsGrid" class="grid"></div>

<button id="btnSalvarSlotsDia" class="btn">
Salvar disponibilidade
</button>

<button id="btnLimparGerador" class="btn-outline">
Limpar sele√ß√£o
</button>

</div>

<!-- ===== RESET GUIADO ===== -->

<div class="card">

<h3>Resetar hor√°rios</h3>

<button id="btnAbrirReset" class="btn-outline">
Abrir gerenciador
</button>

<div id="resetBox" class="hidden">

<select id="resetBarbeiro"></select>

<div id="resetDias"></div>
<div id="resetHorarios" class="grid"></div>

<button id="btnExcluirSlots" class="btn-danger btn">
Excluir hor√°rios selecionados
</button>

</div>
</div>

<!-- ===== FERRAMENTAS ===== -->

<div class="card">
<h3>Ferramentas</h3>

<button id="btnExportarDia" class="btn">
Copiar agenda
</button>

<button id="btnSetup" class="btn-dark btn">
Setup
</button>

<button id="btnDemo" class="btn-dark btn">
Demo
</button>

<button id="btnInstalarApp" class="btn">
Instalar app
</button>

</div>

<!-- ===== AGENDAMENTOS ===== -->

<div class="card">
<h3>Agendamentos</h3>
<div id="listaAgendamentos"></div>
</div>

</div>
<!-- ================= FIREBASE ================= -->

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>

// ================= FIREBASE CONFIG =================

const firebaseConfig = {
apiKey: "AIzaSyBDffb23AqSOoT-8Z94Ao9leB5nTSdIv78",
authDomain: "agenda-barbarujo.firebaseapp.com",
databaseURL: "https://agenda-barbarujo-default-rtdb.firebaseio.com/",
projectId: "agenda-barbarujo",
storageBucket: "agenda-barbarujo.firebasestorage.app",
messagingSenderId: "735138068544",
appId: "1:735138068544:web:5a1273bd8be9ef7ab487a5"
}

firebase.initializeApp(firebaseConfig)
const db = firebase.database()

// ================= REFER√äNCIAS DB =================

const DB = {
servicos: db.ref("barbarujo/servicos"),
barbeiros: db.ref("barbarujo/barbeiros"),
config: db.ref("barbarujo/config"),
ag: db.ref("barbarujo/agendamentos"),
disp: db.ref("barbarujo/disponibilidade")
}

// ================= ESTADO GLOBAL =================

let servicos=[]
let barbeiros=[]
let agendamentos=[]
let agendamentosMap={}
let disponibilidade={}

let servicoSel=null
let barbeiroSel=null
let dataSel=null
let horaSel=null
let salvando=false

// ================= CONFIG FIXA FUNCIONAMENTO =================
// (REMOVIDO DO ADMIN ‚Äî AGORA √â FIXO CONFORME PEDIDO)

const FUNCIONAMENTO = {
semana: [
{ini:"09:00",fim:"12:00"},
{ini:"14:00",fim:"19:00"}
],
sabado: [
{ini:"09:00",fim:"17:00"}
]
}

// ================= IDENTIDADE =================

let NOME_BARBEARIA="BARBARUJO"
let WHATS_BARBEARIA=""

// ================= SENHAS =================

const ADMIN_SENHA="barbarujo123"
const BARBEIRO_SENHA="barbeiro123"

// ================= HELPERS =================

function hojeISO(){
return new Date().toISOString().split("T")[0]
}

function rolarPara(el){
if(!el) return
setTimeout(()=>{
el.scrollIntoView({behavior:"smooth",block:"start"})
},120)
}

function aplicarNome(){
topo.innerText="üíà "+NOME_BARBEARIA
document.title=NOME_BARBEARIA+" ‚Ä¢ Agendamento"
}

aplicarNome()

// ================= TELEFONE M√ÅSCARA =================

clienteFone.addEventListener("input",()=>{
clienteFone.value =
clienteFone.value.replace(/\D/g,"").slice(0,11)
})

// ================= BACK BUTTON GLOBAL =================

btnBackGlobal.onclick=()=>{

// ordem de retorno inteligente

if(!telaAdmin.classList.contains("hidden")){
telaAdmin.classList.add("hidden")
telaCliente.classList.remove("hidden")
return
}

if(!telaBarbeiro.classList.contains("hidden")){
telaBarbeiro.classList.add("hidden")
telaCliente.classList.remove("hidden")
return
}

// cliente ‚Äî voltar passos

if(!cardCliente.classList.contains("hidden")){
cardCliente.classList.add("hidden")
return
}

if(!cardHorarios.classList.contains("hidden")){
cardHorarios.classList.add("hidden")
return
}

if(!cardData.classList.contains("hidden")){
cardData.classList.add("hidden")
return
}

if(!cardBarbeiro.classList.contains("hidden")){
cardBarbeiro.classList.add("hidden")
return
}

// volta splash

document.querySelector(".container").style.display="none"
telaSplash.style.display="flex"

}

// ================= SPLASH ‚Äî CLIENTE =================

btnEntrar.onclick=()=>{
telaSplash.style.display="none"
document.querySelector(".container").style.display="block"
telaCliente.classList.remove("hidden")
rolarPara(cardServico)
}

// ================= SPLASH ‚Äî BARBEIRO =================

btnModoBarbeiro.onclick=()=>{

let s = prompt("Senha barbeiro")

if(s !== BARBEIRO_SENHA){
alert("Senha incorreta")
return
}

telaSplash.style.display="none"
document.querySelector(".container").style.display="block"

telaCliente.classList.add("hidden")
telaAdmin.classList.add("hidden")
telaBarbeiro.classList.remove("hidden")

popularModoBarbeiro()

}

// ================= BARBEIRO ‚Üí CLIENTE =================

btnVoltarCliente.onclick=()=>{
telaBarbeiro.classList.add("hidden")
telaCliente.classList.remove("hidden")
}

// ================= ADMIN LOGIN =================

btnAdminFab.onclick=()=>{

let s=prompt("Senha admin")

if(s===ADMIN_SENHA){
telaCliente.classList.add("hidden")
telaBarbeiro.classList.add("hidden")
telaAdmin.classList.remove("hidden")
}else if(s!==null){
alert("Senha incorreta")
}

}

btnLogout.onclick=()=>{
telaAdmin.classList.add("hidden")
telaCliente.classList.remove("hidden")
}

// ================= PWA INSTALL =================

let deferredPrompt=null

window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault()
deferredPrompt=e
})

btnInstalarApp.onclick=()=>{
if(!deferredPrompt){
alert("Instala√ß√£o n√£o dispon√≠vel agora")
return
}
deferredPrompt.prompt()
}

</script>
<script>

// =====================================================
// ================= RENDER SERVI√áOS ===================
// =====================================================

function formatarPreco(v){
return "R$ " + Number(v).toFixed(2).replace(".",",")
}

function renderServicos(){

listaServicos.innerHTML=""

// centraliza√ß√£o vertical quando s√≥ servi√ßos vis√≠veis
rolarPara(cardServico)

servicos.forEach(s=>{

let b=document.createElement("button")
b.className="btn servico-btn"

// layout interno sofisticado
b.innerHTML=`
<div style="font-size:18px;font-weight:700;margin-bottom:6px">
${s.nome}
</div>

<div class="preco-tag">
${formatarPreco(s.preco)}
</div>
`

b.onclick=()=>{

servicoSel=s

// reset abaixo
barbeiroSel=null
dataSel=null
horaSel=null

cardBarbeiro.classList.remove("hidden")
renderBarbeiros()

cardData.classList.add("hidden")
cardHorarios.classList.add("hidden")
cardCliente.classList.add("hidden")

rolarPara(cardBarbeiro)

}

listaServicos.appendChild(b)

})

}

// =====================================================
// ================= RENDER BARBEIROS ==================
// =====================================================

function renderBarbeiros(){

listaBarbeiros.innerHTML=""

barbeiros.forEach(b=>{

let nome = b.nome || b

let btn=document.createElement("button")
btn.className="btn-outline"
btn.innerText=nome

btn.onclick=()=>{

barbeiroSel = nome

cardData.classList.remove("hidden")
renderDatasCliente()

cardHorarios.classList.add("hidden")
cardCliente.classList.add("hidden")

rolarPara(cardData)

}

listaBarbeiros.appendChild(btn)

})

}

// =====================================================
// ================= DATAS DISPON√çVEIS =================
// =====================================================

function renderDatasCliente(){

dataEscolhida.innerHTML=""

let diasObj = disponibilidade[barbeiroSel] || {}
let dias = Object.keys(diasObj).sort()

if(dias.length===0){
let o=document.createElement("option")
o.textContent="Sem dias dispon√≠veis"
dataEscolhida.appendChild(o)
return
}

dias.forEach(d=>{
let o=document.createElement("option")
o.value=d
o.textContent=d
dataEscolhida.appendChild(o)
})

}

// =====================================================
// ================= CONFIRMAR DATA ====================
// =====================================================

btnConfirmarData.onclick=()=>{

dataSel = dataEscolhida.value

if(!dataSel){
alert("Escolha um dia")
return
}

renderHorariosCliente()

cardHorarios.classList.remove("hidden")
cardCliente.classList.add("hidden")

rolarPara(cardHorarios)

}

// =====================================================
// ================= HOR√ÅRIOS CLIENTE ==================
// =====================================================

function renderHorariosCliente(){

listaHorarios.innerHTML=""
horaSel=null

let lista =
(disponibilidade[barbeiroSel] &&
 disponibilidade[barbeiroSel][dataSel]) || []

if(lista.length===0){
listaHorarios.innerHTML="<div style='opacity:.6'>Sem hor√°rios</div>"
return
}

lista.forEach(hora=>{

let div=document.createElement("div")
div.className="slot"
div.innerText=hora

// bloqueio ocupado realtime

let ocupado = agendamentos.find(a=>
a.data===dataSel &&
a.hora===hora &&
a.barbeiro===barbeiroSel
)

if(ocupado){
div.classList.add("booked")
}

// clique

div.onclick=()=>{

if(div.classList.contains("booked")) return

document
.querySelectorAll("#listaHorarios .slot")
.forEach(s=>s.classList.remove("selected"))

div.classList.add("selected")

horaSel=hora

cardCliente.classList.remove("hidden")
atualizarResumo()

rolarPara(cardCliente)

}

listaHorarios.appendChild(div)

})

}

// =====================================================
// ================= RESUMO ============================
// =====================================================

function atualizarResumo(){

resumoEscolha.innerHTML=`
<span class="badge">Servi√ßo</span> ${servicoSel?.nome||"-"}<br>
<span class="badge">Barbeiro</span> ${barbeiroSel||"-"}<br>
<span class="badge">Data</span> ${dataSel||"-"}<br>
<span class="badge">Hora</span> ${horaSel||"-"}
`

}

</script>
<script>

// =====================================================
// ================= RESERVAR ==========================
// =====================================================

btnReservar.onclick=()=>{

if(!servicoSel || !barbeiroSel || !dataSel || !horaSel){
alert("Complete as escolhas")
return
}

if(!clienteNome.value || !clienteFone.value){
alert("Preencha nome e WhatsApp")
return
}

// trava UI dupla
btnReservar.classList.add("hidden")
btnConfirmar.classList.remove("hidden")

alert("Confira e confirme o agendamento")

}

// =====================================================
// ================= WHATS LOJA ========================
// =====================================================

function enviarWhatsLoja(ag){

if(!WHATS_BARBEARIA) return

let msg =
`üíà NOVO AGENDAMENTO

Cliente: ${ag.cliente}
Whats: ${ag.fone}

Servi√ßo: ${ag.servico}
Valor: ${formatarPreco(ag.preco)}

Barbeiro: ${ag.barbeiro}
Data: ${ag.data}
Hora: ${ag.hora}`

let url =
"https://wa.me/"+WHATS_BARBEARIA+
"?text="+encodeURIComponent(msg)

window.open(url,"_blank")

}

// =====================================================
// ================= CONFIRMAR =========================
// =====================================================

btnConfirmar.onclick=async()=>{

if(salvando) return
salvando=true

if(!servicoSel || !barbeiroSel || !dataSel || !horaSel){
alert("Sele√ß√£o incompleta")
salvando=false
return
}

// ===== VERIFICA CONFLITO REALTIME =====

let snap = await DB.ag
.orderByChild("data")
.equalTo(dataSel)
.get()

let conflito=false

snap.forEach(c=>{
let a=c.val()
if(a.hora===horaSel && a.barbeiro===barbeiroSel){
conflito=true
}
})

if(conflito){
alert("Hor√°rio acabou de ser ocupado")
renderHorariosCliente()
btnConfirmar.classList.add("hidden")
btnReservar.classList.remove("hidden")
salvando=false
return
}

// ===== SALVAR =====

let ag={
servico:servicoSel.nome,
preco:servicoSel.preco,
barbeiro:barbeiroSel,
data:dataSel,
hora:horaSel,
cliente:clienteNome.value,
fone:clienteFone.value,
ts:Date.now()
}

await DB.ag.push(ag)

// ===== WHATS LOJA =====

enviarWhatsLoja(ag)

// ===== FEEDBACK =====

alert("Agendamento confirmado üíà")

// reset fluxo sem reload bruto
resetFluxoCliente()

salvando=false

}

// =====================================================
// ================= RESET FLUXO CLIENTE ===============
// =====================================================

function resetFluxoCliente(){

servicoSel=null
barbeiroSel=null
dataSel=null
horaSel=null

clienteNome.value=""
clienteFone.value=""

btnConfirmar.classList.add("hidden")
btnReservar.classList.remove("hidden")

cardBarbeiro.classList.add("hidden")
cardData.classList.add("hidden")
cardHorarios.classList.add("hidden")
cardCliente.classList.add("hidden")

rolarPara(cardServico)

}

// =====================================================
// ================= AUTO REFRESH HOR√ÅRIOS =============
// =====================================================

function refreshSeClienteAberto(){

if(barbeiroSel && dataSel){
renderHorariosCliente()
}

}

</script>
<script>

// =====================================================
// ================= ADMIN RENDERS =====================
// =====================================================

function renderAdminServicos(){

adminServicos.innerHTML=""

servicos.forEach((s,i)=>{

let div=document.createElement("div")
div.className="card card-sub"

div.innerHTML=`
<b style="font-size:16px">${s.nome}</b>
<div class="preco-tag" style="margin:6px 0">
${formatarPreco(s.preco)}
</div>

<button class="btn-danger btn"
onclick="removerServico(${i})">
Excluir servi√ßo
</button>
`

adminServicos.appendChild(div)

})

}

// -----------------------------------------------------

function renderAdminBarbeiros(){

adminBarbeiros.innerHTML=""

barbeiros.forEach((b,i)=>{

let nome=b.nome||b
let whats=b.whats||""

let div=document.createElement("div")
div.className="card card-sub"

div.innerHTML=`
<b>${nome}</b><br>
Whats: ${whats||"-"}

<input id="wb_${i}" placeholder="Whats barbeiro">

<button class="btn-dark btn"
onclick="salvarWhatsBarbeiro(${i})">
Salvar Whats
</button>

<button class="btn-danger btn"
onclick="removerBarbeiro(${i})">
Excluir barbeiro
</button>
`

adminBarbeiros.appendChild(div)

})

}

// -----------------------------------------------------

function renderAdminAgendamentos(){

listaAgendamentos.innerHTML=""

Object.entries(agendamentosMap).forEach(([key,a])=>{

let div=document.createElement("div")
div.className="card card-sub"

div.innerHTML=`
<span class="badge">${a.data} ${a.hora}</span>
<br><br>

${a.servico} ‚Äî ${a.barbeiro}<br>
<b>${a.cliente}</b><br>
Whats: ${a.fone}<br>

<div class="preco-tag" style="margin:8px 0">
${formatarPreco(a.preco)}
</div>

<button class="btn-danger btn"
onclick="excluirAgendamento('${key}')">
Excluir agendamento
</button>
`

listaAgendamentos.appendChild(div)

})

}

// =====================================================
// ================= CRUD SERVI√áOS =====================
// =====================================================

btnAddServico.onclick=()=>{

if(!novoServicoNome.value || !novoServicoPreco.value){
alert("Preencha nome e pre√ßo")
return
}

servicos.push({
nome:novoServicoNome.value,
preco:Number(novoServicoPreco.value)
})

DB.servicos.set(servicos)

novoServicoNome.value=""
novoServicoPreco.value=""

alert("Servi√ßo adicionado")

}

function removerServico(i){

if(!confirm("Excluir servi√ßo?")) return

servicos.splice(i,1)
DB.servicos.set(servicos)

}

// =====================================================
// ================= CRUD BARBEIROS ====================
// =====================================================

btnAddBarbeiro.onclick=()=>{

if(!novoBarbeiro.value){
alert("Digite o nome")
return
}

barbeiros.push({
nome:novoBarbeiro.value,
whats:""
})

DB.barbeiros.set(barbeiros)

novoBarbeiro.value=""

alert("Barbeiro adicionado")

}

function removerBarbeiro(i){

if(!confirm("Excluir barbeiro?")) return

barbeiros.splice(i,1)
DB.barbeiros.set(barbeiros)

}

// =====================================================
// ================= WHATS BARBEIRO ====================
// =====================================================

function salvarWhatsBarbeiro(i){

let v=document
.getElementById("wb_"+i)
.value.replace(/\D/g,"")

if(v.length<10){
alert("Whats inv√°lido")
return
}

barbeiros[i].whats=v
DB.barbeiros.set(barbeiros)

alert("Whats do barbeiro salvo")

}

// =====================================================
// ================= EXCLUIR AGENDAMENTO ===============
// =====================================================

function excluirAgendamento(key){

if(!confirm("Excluir agendamento?")) return

DB.ag.child(key).remove()

alert("Agendamento exclu√≠do")

}

// =====================================================
// ================= WHATS LOJA ADMIN ==================
// =====================================================

btnSalvarWhats.onclick=()=>{

let w = cfgWhats.value.replace(/\D/g,"")

if(w.length<10){
alert("Whats inv√°lido")
return
}

DB.config.child("whats").set(w)

alert("WhatsApp da loja salvo")

}

</script>
<script>

// =====================================================
// ===== HOR√ÅRIOS FIXOS POR DIA DA SEMANA ==============
// =====================================================

function blocosDia(dataISO){

let d = new Date(dataISO+"T00:00:00")
let dia = d.getDay()

// 0 = domingo
if(dia===0){
return []
}

// s√°bado
if(dia===6){
return FUNCIONAMENTO.sabado
}

// seg-sex
return FUNCIONAMENTO.semana

}

// =====================================================
// ===== GERAR LISTA HOR√ÅRIOS FIXOS ====================
// =====================================================

function gerarSlotsFixos(dataISO){

let blocos = blocosDia(dataISO)

if(blocos.length===0){
return []
}

let lista=[]
let intervalo = 30 // fixo ‚Äî conforme padr√£o app

blocos.forEach(b=>{

let [ai,af] = [b.ini,b.fim]

let [ha,ma]=ai.split(":").map(Number)
let [hf,mf]=af.split(":").map(Number)

let ini=ha*60+ma
let fim=hf*60+mf

for(let t=ini;t<fim;t+=intervalo){

let h=Math.floor(t/60).toString().padStart(2,"0")
let m=(t%60).toString().padStart(2,"0")

lista.push(h+":"+m)

}

})

return lista

}

// =====================================================
// ===== POPULAR SELECTS BARBEIRO ======================
// =====================================================

function popularSelectsBarbeiro(){

adminBarbeiroSel.innerHTML=""
resetBarbeiro.innerHTML=""
barbeiroModoSel.innerHTML=""

barbeiros.forEach(b=>{

let nome=b.nome||b

adminBarbeiroSel.add(new Option(nome,nome))
resetBarbeiro.add(new Option(nome,nome))
barbeiroModoSel.add(new Option(nome,nome))

})

}

// =====================================================
// ===== ADMIN GERAR HOR√ÅRIOS ==========================
// =====================================================

btnGerarSlots.onclick=()=>{

let barbeiro = adminBarbeiroSel.value
let data = adminDataPick.value

if(!barbeiro || !data){
alert("Escolha barbeiro e data")
return
}

let base = gerarSlotsFixos(data)

if(base.length===0){
alert("Domingo fechado")
return
}

// hor√°rios j√° salvos
let ja =
(disponibilidade[barbeiro] &&
 disponibilidade[barbeiro][data]) || []

adminSlotsGrid.innerHTML=""

base.forEach(hora=>{

let div=document.createElement("div")
div.className="slot"
div.innerText=hora

if(ja.includes(hora)){
div.classList.add("selected")
}

div.onclick=()=>div.classList.toggle("selected")

adminSlotsGrid.appendChild(div)

})

rolarPara(adminSlotsGrid)

}

// =====================================================
// ===== SALVAR DISPONIBILIDADE ========================
// =====================================================

btnSalvarSlotsDia.onclick=()=>{

let barbeiro=adminBarbeiroSel.value
let data=adminDataPick.value

if(!barbeiro || !data){
alert("Escolha barbeiro e data")
return
}

let sel=[]

document
.querySelectorAll("#adminSlotsGrid .slot.selected")
.forEach(s=>sel.push(s.innerText))

if(sel.length===0){
alert("Selecione hor√°rios")
return
}

if(!confirm("Salvar disponibilidade?")) return

DB.disp
.child(barbeiro)
.child(data)
.set(sel)

alert("Disponibilidade salva")

// LIMPA UI ‚Äî pedido seu

adminSlotsGrid.innerHTML=""
adminDataPick.value=""

}

// =====================================================
// ===== LIMPAR GERADOR ===============================
// =====================================================

btnLimparGerador.onclick=()=>{
adminSlotsGrid.innerHTML=""
}

</script>
<script>

// =====================================================
// ================= RESET GUIADO ======================
// =====================================================

btnAbrirReset.onclick=()=>{

resetBox.classList.toggle("hidden")

if(!resetBox.classList.contains("hidden")){
renderResetDias()
rolarPara(resetBox)
}

}

// =====================================================
// ================= RESET ‚Äî DIAS ======================
// =====================================================

resetBarbeiro.onchange = renderResetDias

function renderResetDias(){

resetDias.innerHTML=""
resetHorarios.innerHTML=""

let barbeiro = resetBarbeiro.value

if(!barbeiro){
resetDias.innerHTML="Escolha o barbeiro"
return
}

let diasObj = disponibilidade[barbeiro] || {}
let dias = Object.keys(diasObj).sort()

if(dias.length===0){
resetDias.innerHTML="Sem dias cadastrados"
return
}

dias.forEach(d=>{

let b=document.createElement("button")
b.className="btn-dark btn"
b.style.marginBottom="10px"
b.textContent=d

b.onclick=()=>{
renderResetHorarios(barbeiro,d)
}

resetDias.appendChild(b)

})

}

// =====================================================
// ================= RESET ‚Äî HOR√ÅRIOS ==================
// =====================================================

function renderResetHorarios(barbeiro,data){

resetHorarios.innerHTML=""

let lista =
(disponibilidade[barbeiro] &&
 disponibilidade[barbeiro][data]) || []

if(lista.length===0){
resetHorarios.innerHTML="Sem hor√°rios neste dia"
return
}

lista.forEach(h=>{

let div=document.createElement("div")
div.className="slot"
div.innerText=h

div.onclick=()=>{
div.classList.toggle("selected")
}

resetHorarios.appendChild(div)

})

resetHorarios.dataset.barbeiro = barbeiro
resetHorarios.dataset.data = data

rolarPara(resetHorarios)

}

// =====================================================
// ================= EXCLUIR HOR√ÅRIOS ==================
// =====================================================

btnExcluirSlots.onclick=()=>{

let barbeiro = resetHorarios.dataset.barbeiro
let data = resetHorarios.dataset.data

if(!barbeiro || !data){
alert("Escolha barbeiro e dia")
return
}

let remover=[]

document
.querySelectorAll("#resetHorarios .slot.selected")
.forEach(s=>remover.push(s.innerText))

if(remover.length===0){
alert("Selecione hor√°rios")
return
}

if(!confirm("Excluir hor√°rios selecionados?"))
return

let atuais =
(disponibilidade[barbeiro] &&
 disponibilidade[barbeiro][data]) || []

let novos = atuais.filter(h=>!remover.includes(h))

DB.disp
.child(barbeiro)
.child(data)
.set(novos)

alert("Hor√°rios removidos")

// atualiza tela
renderResetHorarios(barbeiro,data)

}

// =====================================================
// ================= UX RESET ==========================
// =====================================================

// limpa hor√°rios ao trocar barbeiro

resetBarbeiro.addEventListener("change",()=>{
resetHorarios.innerHTML=""
})

</script>
<script>

// =====================================================
// ================= MODO BARBEIRO =====================
// =====================================================

function popularModoBarbeiro(){

barbeiroModoSel.innerHTML=""

barbeiros.forEach(b=>{

let nome=b.nome||b

let o=document.createElement("option")
o.value=nome
o.textContent=nome

barbeiroModoSel.appendChild(o)

})

}

// =====================================================
// ================= VER AGENDA ========================
// =====================================================

btnVerAgendaBarbeiro.onclick=renderAgendaBarbeiro

function renderAgendaBarbeiro(){

let nome = barbeiroModoSel.value
let data = barbeiroModoData.value || hojeISO()

listaBarbeiroAgenda.innerHTML=""

if(!nome){
listaBarbeiroAgenda.innerHTML="Escolha barbeiro"
return
}

let lista = agendamentos
.filter(a=>a.barbeiro===nome && a.data===data)
.sort((a,b)=>a.hora.localeCompare(b.hora))

if(lista.length===0){
listaBarbeiroAgenda.innerHTML="Sem clientes neste dia"
return
}

lista.forEach(a=>{

let div=document.createElement("div")
div.className="card card-sub"

div.innerHTML=`

<span class="badge">${a.hora}</span>
<br><br>

<b>${a.cliente}</b><br>
Servi√ßo: ${a.servico}<br>

<div class="preco-tag">
${formatarPreco(a.preco)}
</div>

<br>

<button class="btn-dark btn"
onclick="window.open('https://wa.me/55${a.fone}','_blank')">
Abrir WhatsApp
</button>

<button class="btn-outline"
onclick="copiarFone('${a.fone}')">
Copiar telefone
</button>

<button class="btn"
onclick="enviarLembreteCliente('${a.cliente}','${a.fone}','${a.data}','${a.hora}','${a.servico}')">
Enviar lembrete
</button>

`

listaBarbeiroAgenda.appendChild(div)

})

}

// =====================================================
// ================= LEMBRETE CLIENTE ==================
// =====================================================

function enviarLembreteCliente(nome,fone,data,hora,servico){

let msg =
`üíà ${NOME_BARBEARIA}

Ol√° ${nome}!
Lembrete do seu hor√°rio:

Servi√ßo: ${servico}
Data: ${data}
Hora: ${hora}

Te esperamos üëç`

let url =
"https://wa.me/55"+
fone.replace(/\D/g,"")+
"?text="+encodeURIComponent(msg)

window.open(url,"_blank")

}

// =====================================================
// ================= COPIAR TELEFONE ===================
// =====================================================

function copiarFone(f){

navigator.clipboard.writeText(f)
alert("Telefone copiado")

}

// =====================================================
// ================= REALTIME SYNC =====================
// =====================================================

DB.servicos.on("value",snap=>{

if(snap.exists()){
servicos = Object.values(snap.val())
}else{
DB.servicos.set([
{nome:"Corte",preco:40},
{nome:"Barba",preco:30},
{nome:"Combo",preco:65}
])
return
}

renderServicos()
renderAdminServicos()

})

// -----------------------------------------------------

DB.barbeiros.on("value",snap=>{

if(snap.exists()){
barbeiros = Object.values(snap.val())
}else{
DB.barbeiros.set([
{nome:"Carlos",whats:""},
{nome:"Pedro",whats:""}
])
return
}

renderBarbeiros()
renderAdminBarbeiros()
popularSelectsBarbeiro()
popularModoBarbeiro()

})

// -----------------------------------------------------

DB.disp.on("value",snap=>{

disponibilidade = snap.exists()? snap.val() : {}

if(barbeiroSel){
renderDatasCliente()
}

renderResetDias()

})

// -----------------------------------------------------

DB.ag.on("value",snap=>{

agendamentosMap = snap.exists()? snap.val() : {}
agendamentos = Object.values(agendamentosMap)

renderAdminAgendamentos()
refreshSeClienteAberto()

if(!telaBarbeiro.classList.contains("hidden")){
renderAgendaBarbeiro()
}

})

// -----------------------------------------------------

DB.config.child("whats").on("value",snap=>{
if(snap.exists()){
WHATS_BARBEARIA=snap.val()
cfgWhats.value=WHATS_BARBEARIA
}
})

// =====================================================
// ================= EXPORTAR ==========================
// =====================================================

btnExportarDia.onclick=()=>{

let hoje=hojeISO()

let lista = agendamentos
.filter(a=>a.data===hoje)
.sort((a,b)=>a.hora.localeCompare(b.hora))

if(lista.length===0){
alert("Sem agendamentos hoje")
return
}

let txt=`AGENDA ${NOME_BARBEARIA} ‚Äî ${hoje}\n\n`

lista.forEach(a=>{
txt+=`${a.hora} ‚Äî ${a.cliente} ‚Äî ${a.servico}\n`
})

navigator.clipboard.writeText(txt)
alert("Agenda copiada")

}

// =====================================================
// ================= SETUP =============================
// =====================================================

btnSetup.onclick=()=>{

let nome=prompt("Nome da barbearia:")

if(nome){
NOME_BARBEARIA=nome.toUpperCase()
aplicarNome()
}

alert("Setup aplicado")

}

// =====================================================
// ================= DEMO ==============================
// =====================================================

btnDemo.onclick=()=>{

DB.ag.push({
servico:"Corte",
preco:40,
barbeiro:"Carlos",
data:hojeISO(),
hora:"10:00",
cliente:"Cliente Demo",
fone:"11999999999",
ts:Date.now()
})

alert("Demo criado")

}

// =====================================================
// ================= UX TRAVAS MOBILE ==================
// =====================================================

// bloquear zoom duplo toque

let lastTouchEnd = 0

document.addEventListener("touchend", function (event) {
let now = Date.now()
if (now - lastTouchEnd <= 300) {
event.preventDefault()
}
lastTouchEnd = now
}, { passive:false })

// bloquear copiar / segurar

document.addEventListener("contextmenu", e=>e.preventDefault())
document.addEventListener("selectstart", e=>e.preventDefault())

// =====================================================
// ================= SERVICE WORKER ====================
// =====================================================

if("serviceWorker" in navigator){
navigator.serviceWorker.register("sw.js")
}

// =====================================================
// ================= LOG FINAL =========================
// =====================================================

console.log("üíà BARBARUJO FINAL V3 PREMIUM ATIVO")

</script>

</div>
</body>
</html>
