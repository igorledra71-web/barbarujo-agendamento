<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda Barbearia Firebase</title>

<style>

*{box-sizing:border-box}

body{
margin:0;
font-family:Arial,Helvetica,sans-serif;
background:#0b0b0b;
color:#eee;
}

header{
padding:18px;
text-align:center;
background:#000;
border-bottom:1px solid #222;
letter-spacing:2px;
font-weight:bold;
}

.card{
margin:14px;
padding:16px;
border-radius:14px;
background:#151515;
border:1px solid #262626;
}

h2{
margin:0 0 10px 0;
color:#f1d27a;
font-size:16px;
}

input,select{
width:100%;
padding:12px;
margin:6px 0 12px 0;
border-radius:10px;
border:1px solid #333;
background:#101010;
color:#fff;
}

button{
width:100%;
padding:12px;
border-radius:12px;
border:none;
font-weight:bold;
background:linear-gradient(135deg,#d4af37,#f5d77a);
color:#111;
cursor:pointer;
}

.item{
background:#101010;
border:1px solid #262626;
padding:10px;
border-radius:10px;
margin:8px 0;
}

.hidden{display:none}

.grid{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:8px;
}

.slot{
padding:10px;
border-radius:10px;
background:#1a1a1a;
border:1px solid #333;
text-align:center;
cursor:pointer;
}

.adminBtn{
position:fixed;
bottom:14px;
right:14px;
opacity:.3;
font-size:24px;
cursor:pointer;
}

.modal{
position:fixed;
inset:0;
background:rgba(0,0,0,.7);
display:flex;
align-items:center;
justify-content:center;
}

.modalBox{
width:92%;
max-width:420px;
background:#111;
border-radius:16px;
padding:16px;
border:1px solid #333;
}

</style>
</head>

<body>

<header>AGENDA BARBEARIA</header>
<!-- LOGIN CLIENTE -->

<div class="card" id="loginBox">
<h2>Entrar</h2>

<input id="cliNome" placeholder="Nome">
<input id="cliTel" placeholder="WhatsApp">

<button onclick="loginCliente()">Entrar</button>
</div>



<!-- AREA CLIENTE -->

<div id="areaCliente" class="hidden">

<div class="card">
<h2>Novo Agendamento</h2>

<label>Barbeiro</label>
<select id="barbeiro"></select>

<label>Serviço</label>
<select id="servico"></select>

<label>Data</label>
<input type="date" id="dataInp">

<label>Horário</label>
<input id="horaView" readonly>
<button onclick="abrirHoras()">Escolher Horário</button>

<button onclick="confirmarAgendamento()">Confirmar</button>
</div>


<div class="card">
<h2>Meus Agendamentos</h2>
<div id="listaMeus"></div>
</div>

</div>



<!-- BOTÃO ADMIN -->

<div class="adminBtn" onclick="abrirAdmin()">⚙</div>



<!-- LOGIN ADMIN -->

<div class="card hidden" id="adminLogin">
<h2>Painel Admin</h2>
<input type="password" id="admSenha" placeholder="Senha">
<button onclick="loginAdmin()">Entrar</button>
</div>



<!-- AREA ADMIN -->

<div id="areaAdmin" class="hidden">

<div class="card">
<h2>Barbeiros</h2>
<input id="novoBarbeiro">
<button onclick="addBarbeiro()">Adicionar</button>
<div id="listaBarbeiros"></div>
</div>


<div class="card">
<h2>Serviços</h2>
<input id="novoServico">
<button onclick="addServico()">Adicionar</button>
<div id="listaServicos"></div>
</div>


<div class="card">
<h2>Horários do Dia</h2>
<input type="date" id="admData">
<input type="time" id="admHora">
<button onclick="addDisponivel()">Liberar Horário</button>
<div id="listaDisp"></div>
</div>

</div>



<!-- MODAL HORÁRIOS -->

<div class="modal hidden" id="modalHoras">
<div class="modalBox">

<h2>Escolher Horário</h2>
<div class="grid" id="gridHoras"></div>

<button onclick="fecharHoras()">Fechar</button>

</div>
</div>
<!-- FIREBASE SDK -->

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
getFirestore,
collection,
addDoc,
doc,
setDoc,
deleteDoc,
onSnapshot,
query,
where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


// =======================
// FIREBASE CONFIG
// =======================

const firebaseConfig = {
apiKey: "AIzaSyDQxyKbp3vrHW0JJEh9mo0sDHc7Zpp5IP8",
authDomain: "agenda-barbearia-a5cd8.firebaseapp.com",
projectId: "agenda-barbearia-a5cd8",
storageBucket: "agenda-barbearia-a5cd8.firebasestorage.app",
messagingSenderId: "1007861244973",
appId: "1:1007861244973:web:dc7c2fed43431e281e84a4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// =======================
// ESTADO GLOBAL
// =======================

let horaSel = null;
let cacheBarbeiros = [];
let cacheServicos = [];
let cacheDisp = [];
let cacheAg = [];


// =======================
// REFERÊNCIAS
// =======================

const colBarb = collection(db,"barbeiros");
const colServ = collection(db,"servicos");
const colDisp = collection(db,"disponibilidade");
const colAg   = collection(db,"agendamentos");
// =======================
// LISTENERS REALTIME
// =======================

// barbeiros
onSnapshot(colBarb, snap=>{
cacheBarbeiros = snap.docs.map(d=>({id:d.id,...d.data()}));
renderBarbeirosSelect();
renderBarbeirosAdmin();
});

// serviços
onSnapshot(colServ, snap=>{
cacheServicos = snap.docs.map(d=>({id:d.id,...d.data()}));
renderServicosSelect();
renderServicosAdmin();
});

// disponibilidade
onSnapshot(colDisp, snap=>{
cacheDisp = snap.docs.map(d=>({id:d.id,...d.data()}));
renderDispAdmin();
});

// agendamentos
onSnapshot(colAg, snap=>{
cacheAg = snap.docs.map(d=>({id:d.id,...d.data()}));
renderMeus();
});


// =======================
// LOGIN CLIENTE
// =======================

function loginCliente(){

const n = cliNome.value.trim();
const t = cliTel.value.trim();

if(!n || !t){
alert("Preencha");
return;
}

localStorage.setItem("cliNome",n);
localStorage.setItem("cliTel",t);

loginBox.classList.add("hidden");
areaCliente.classList.remove("hidden");
}


// =======================
// LOGIN ADMIN
// =======================

function abrirAdmin(){
adminLogin.classList.remove("hidden");
}

function loginAdmin(){

if(admSenha.value !== "1234"){
alert("Senha incorreta");
return;
}

adminLogin.classList.add("hidden");
areaAdmin.classList.remove("hidden");
}


// =======================
// SELECTS
// =======================

function renderBarbeirosSelect(){
barbeiro.innerHTML="";
cacheBarbeiros.forEach(b=>{
barbeiro.innerHTML += `<option>${b.nome}</option>`;
});
}

function renderServicosSelect(){
servico.innerHTML="";
cacheServicos.forEach(s=>{
servico.innerHTML += `<option>${s.nome}</option>`;
});
}
// =======================
// MODAL HORÁRIOS
// =======================

function abrirHoras(){

const data = dataInp.value;

if(!data){
alert("Escolha a data");
return;
}

const lista = cacheDisp.filter(d=>d.data===data);

if(lista.length === 0){
alert("Nenhum horário liberado para este dia");
return;
}

modalHoras.classList.remove("hidden");
renderHoras();
}


function fecharHoras(){
modalHoras.classList.add("hidden");
}



// =======================
// RENDER HORÁRIOS
// =======================

function renderHoras(){

gridHoras.innerHTML = "";
horaSel = null;
horaView.value = "";

const data = dataInp.value;

const lista = cacheDisp
.filter(d=>d.data===data)
.map(d=>d.hora)
.sort();

if(lista.length === 0){
gridHoras.innerHTML =
"<div style='grid-column:1/-1;opacity:.7'>Sem horários</div>";
return;
}

lista.forEach(h=>{

gridHoras.innerHTML += `
<div class="slot"
onclick="selHora('${h}', this)">
${h}
</div>
`;

});
}



// =======================
// SELECIONAR HORA
// =======================

function selHora(h,el){

horaSel = h;
horaView.value = h;

document.querySelectorAll(".slot")
.forEach(x=>x.classList.remove("sel"));

el.classList.add("sel");
}
// =======================
// CONFIRMAR AGENDAMENTO
// =======================

async function confirmarAgendamento(){

const data = dataInp.value;

if(!data || !horaSel){
alert("Escolha data e horário");
return;
}

const barb = barbeiro.value;
const serv = servico.value;
const nome = localStorage.getItem("cliNome");
const tel  = localStorage.getItem("cliTel");


// ===== VALIDAR DISPONIBILIDADE =====

const ok = cacheDisp.some(d =>
d.data===data && d.hora===horaSel
);

if(!ok){
alert("Horário não disponível");
return;
}


// ===== CONFLITO =====

const conflito = cacheAg.some(a =>
a.data===data &&
a.hora===horaSel &&
a.barbeiro===barb &&
a.status==="ativo"
);

if(conflito){
alert("Barbeiro ocupado nesse horário");
return;
}


// ===== GRAVAR =====

await addDoc(colAg,{
nome:nome,
tel:tel,
barbeiro:barb,
servico:serv,
data:data,
hora:horaSel,
status:"ativo",
criado: Date.now()
});

alert("Agendamento confirmado");

fecharHoras();
}
// =======================
// LISTA DO CLIENTE
// =======================

function renderMeus(){

const tel = localStorage.getItem("cliTel");

if(!tel){
listaMeus.innerHTML = "";
return;
}

listaMeus.innerHTML = "";

cacheAg
.filter(a => a.tel === tel && a.status === "ativo")
.sort((a,b)=>(a.data+a.hora).localeCompare(b.data+b.hora))
.forEach(a=>{

listaMeus.innerHTML += `
<div class="item">
${a.data} ${a.hora}<br>
${a.servico} — ${a.barbeiro}
<button onclick="cancelarAg('${a.id}')">Cancelar</button>
</div>
`;

});
}



// =======================
// CANCELAR AGENDAMENTO
// =======================

async function cancelarAg(id){

await deleteDoc(doc(db,"agendamentos",id));

}
// =======================
// ADMIN — BARBEIROS
// =======================

async function addBarbeiro(){

const nome = novoBarbeiro.value.trim();
if(!nome) return;

await addDoc(colBarb,{nome:nome});
novoBarbeiro.value="";
}

function renderBarbeirosAdmin(){

listaBarbeiros.innerHTML="";

cacheBarbeiros.forEach(b=>{
listaBarbeiros.innerHTML += `
<div class="item">
${b.nome}
<button onclick="delBarbeiro('${b.id}')">Excluir</button>
</div>`;
});
}

async function delBarbeiro(id){
await deleteDoc(doc(db,"barbeiros",id));
}



// =======================
// ADMIN — SERVIÇOS
// =======================

async function addServico(){

const nome = novoServico.value.trim();
if(!nome) return;

await addDoc(colServ,{nome:nome});
novoServico.value="";
}

function renderServicosAdmin(){

listaServicos.innerHTML="";

cacheServicos.forEach(s=>{
listaServicos.innerHTML += `
<div class="item">
${s.nome}
<button onclick="delServico('${s.id}')">Excluir</button>
</div>`;
});
}

async function delServico(id){
await deleteDoc(doc(db,"servicos",id));
}



// =======================
// ADMIN — DISPONIBILIDADE
// =======================

async function addDisponivel(){

const d = admData.value;
const h = admHora.value;

if(!d || !h){
alert("Escolha data/hora");
return;
}

await addDoc(colDisp,{
data:d,
hora:h
});
}

function renderDispAdmin(){

if(!admData.value){
listaDisp.innerHTML="";
return;
}

listaDisp.innerHTML="";

cacheDisp
.filter(x=>x.data===admData.value)
.sort((a,b)=>a.hora.localeCompare(b.hora))
.forEach(x=>{
listaDisp.innerHTML += `
<div class="item">
${x.hora}
<button onclick="delDisp('${x.id}')">Remover</button>
</div>`;
});
}

async function delDisp(id){
await deleteDoc(doc(db,"disponibilidade",id));
}

admData.onchange = renderDispAdmin;



// =======================
// FIM SCRIPT
// =======================

</script>

</body>
</html>
