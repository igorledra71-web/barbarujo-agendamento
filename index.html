<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barbarujo Agenda Pro</title>

<style>

*{box-sizing:border-box}

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
background:
radial-gradient(circle at 20% 10%,#1a1a1a,transparent 40%),
radial-gradient(circle at 90% 90%,#141414,transparent 40%),
#0b0b0b;
color:#f2f2f2;
}

header{
padding:22px 16px;
text-align:center;
font-weight:700;
letter-spacing:2px;
font-size:18px;
background:linear-gradient(180deg,#000,#111);
border-bottom:1px solid rgba(255,255,255,.08);
position:sticky;
top:0;
z-index:5;
}

.card{
margin:14px;
padding:18px;
border-radius:18px;
background:linear-gradient(180deg,#1b1b1b,#0f0f0f);
border:1px solid rgba(255,255,255,.06);
box-shadow:
0 20px 40px rgba(0,0,0,.7),
inset 0 1px 0 rgba(255,255,255,.05);
animation:fadeUp .35s ease;
}

@keyframes fadeUp{
from{opacity:0; transform:translateY(10px)}
to{opacity:1; transform:translateY(0)}
}

h2{
margin:0 0 12px 0;
font-size:16px;
color:#f1d27a;
}

label{
font-size:12px;
opacity:.85;
}

input,select{
width:100%;
padding:14px;
margin:6px 0 14px 0;
border-radius:14px;
border:1px solid rgba(255,255,255,.08);
background:#121212;
color:white;
font-size:15px;
}

button{
width:100%;
padding:15px;
border-radius:16px;
border:none;
font-weight:700;
letter-spacing:.5px;
background:linear-gradient(135deg,#d4af37,#f5d77a);
color:#111;
cursor:pointer;
box-shadow:0 10px 22px rgba(212,175,55,.35);
}

button:active{
transform:scale(.97);
}

.item{
background:#141414;
border:1px solid rgba(255,255,255,.06);
padding:12px;
border-radius:14px;
margin:8px 0;
font-size:14px;
}

.row{
display:flex;
gap:8px;
}

.hidden{display:none}

.adminBtn{
position:fixed;
bottom:14px;
right:14px;
font-size:26px;
opacity:.18;
cursor:pointer;
}

.modal{
position:fixed;
inset:0;
background:rgba(0,0,0,.65);
display:flex;
align-items:center;
justify-content:center;
z-index:20;
}

.modalBox{
width:92%;
max-width:420px;
background:#0f0f0f;
border-radius:20px;
padding:18px;
border:1px solid rgba(255,255,255,.08);
box-shadow:0 30px 60px rgba(0,0,0,.8);
}

.calGrid{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:6px;
}

.calCell{
padding:10px;
border-radius:10px;
text-align:center;
background:#181818;
border:1px solid #2a2a2a;
cursor:pointer;
font-size:13px;
}

.calCell.sel{
background:#f5d77a;
color:#000;
font-weight:700;
}

.clockGrid{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:8px;
}

.clockBtn{
padding:12px;
border-radius:12px;
background:#1c1c1c;
border:1px solid #333;
text-align:center;
cursor:pointer;
}

.clockBtn.sel{
background:#f5d77a;
color:#000;
font-weight:700;
}

.clockBtn.off{
opacity:.35;
text-decoration:line-through;
cursor:not-allowed;
}

</style>
</head>
<body>

<header>BARBARUJO AGENDA PRO</header>
<!-- LOGIN CLIENTE -->

<div class="card" id="loginBox">
<h2>Entrar</h2>

<label>Nome</label>
<input id="cliNome">

<label>WhatsApp</label>
<input id="cliTel">

<button onclick="loginCliente()">Entrar</button>
</div>



<!-- APP CLIENTE -->

<div id="appCliente" class="hidden">

<div class="card">

<h2>Novo Agendamento</h2>

<label>Barbeiro</label>
<select id="barbeiro"></select>

<label>Serviço</label>
<select id="servico"></select>

<label>Data</label>
<input id="dataView" readonly placeholder="Toque para escolher">
<button onclick="abrirCalendario()">Selecionar Data</button>

<label>Horário</label>
<input id="horaView" readonly placeholder="Toque para escolher">
<button onclick="abrirRelogio()">Selecionar Horário</button>

<button onclick="confirmarAgendamento()">Confirmar Agendamento</button>

</div>


<div class="card">
<h2>Meus Agendamentos</h2>
<div id="listaMeus"></div>
</div>

</div>



<!-- BOTÃO ADMIN -->

<div class="adminBtn" onclick="abrirAdmin()">⚙</div>



<!-- LOGIN ADMIN -->

<div class="card hidden" id="adminLogin">
<h2>Painel Admin</h2>

<input type="password" id="adminSenha" placeholder="Senha">
<button onclick="loginAdmin()">Entrar</button>

</div>



<!-- ADMIN APP -->

<div id="adminApp" class="hidden">

<div class="card">
<h2>Configuração</h2>

<label>Limite encaixe por horário</label>
<input type="number" id="cfgLimite">

<button onclick="salvarConfig()">Salvar Config</button>
</div>



<div class="card">
<h2>Barbeiros</h2>

<input id="novoBarbeiro" placeholder="Nome barbeiro">
<button onclick="addBarbeiro()">Adicionar</button>

<div id="listaBarbeiros"></div>
</div>



<div class="card">
<h2>Serviços</h2>

<input id="novoServico" placeholder="Nome serviço">
<button onclick="addServico()">Adicionar</button>

<div id="listaServicos"></div>
</div>



<div class="card">
<h2>Agenda Geral</h2>
<div id="agendaAdmin"></div>
</div>



<div class="card">

<h2>Horários Disponíveis do Dia</h2>

<input type="date" id="admDataDisp">

<label>Adicionar horário</label>
<input type="time" id="admHoraDisp">
<button onclick="addHoraDisponivel()">Adicionar</button>

<div id="listaDisp"></div>

</div>

</div>



<!-- MODAL CALENDÁRIO -->

<div class="modal hidden" id="modalCal">
<div class="modalBox">

<h2>Escolher Data</h2>

<div id="calTitulo"></div>
<div class="calGrid" id="calGrid"></div>

<button onclick="fecharCalendario()">Fechar</button>

</div>
</div>



<!-- MODAL RELÓGIO -->

<div class="modal hidden" id="modalClock">
<div class="modalBox">

<h2>Escolher Horário</h2>

<div class="clockGrid" id="clockGrid"></div>

<button onclick="fecharRelogio()">Fechar</button>

</div>
</div>
<script>

// =======================
// BANCO LOCAL
// =======================

function dbGet(k, def){
return JSON.parse(localStorage.getItem(k) || JSON.stringify(def));
}

function dbSet(k,v){
localStorage.setItem(k, JSON.stringify(v));
}


// =======================
// DADOS INICIAIS
// =======================

if(!localStorage.getItem("barbeiros")){
dbSet("barbeiros",["Carlos","João"]);
}

if(!localStorage.getItem("servicos")){
dbSet("servicos",[
{nome:"Corte",preco:35,duracao:30},
{nome:"Corte + Barba",preco:55,duracao:50}
]);
}

if(!localStorage.getItem("agendamentos")){
dbSet("agendamentos",[]);
}

if(!localStorage.getItem("disponibilidade")){
dbSet("disponibilidade",[]);
}

if(!localStorage.getItem("config")){
dbSet("config",{limite:2,buffer:5});
}


// =======================
// ESTADO GLOBAL
// =======================

let dataSel = null;
let horaSel = null;


// =======================
// LOGIN CLIENTE
// =======================

function loginCliente(){

const nome = cliNome.value.trim();
const tel = cliTel.value.trim();

if(!nome || !tel){
alert("Preencha os dados");
return;
}

localStorage.setItem("cliNome",nome);
localStorage.setItem("cliTel",tel);

loginBox.classList.add("hidden");
appCliente.classList.remove("hidden");

carregarSelects();
listarMeus();
}


// =======================
// ADMIN LOGIN
// =======================

function abrirAdmin(){
adminLogin.classList.remove("hidden");
}

function loginAdmin(){

if(adminSenha.value !== "1234"){
alert("Senha incorreta");
return;
}

adminLogin.classList.add("hidden");
adminApp.classList.remove("hidden");

carregarAdmin();
}


// =======================
// SELECTS
// =======================

function carregarSelects(){

const bs = dbGet("barbeiros",[]);
barbeiro.innerHTML="";
bs.forEach(b=>barbeiro.innerHTML+=`<option>${b}</option>`);

const ss = dbGet("servicos",[]);
servico.innerHTML="";
ss.forEach(s=>{
servico.innerHTML+=
`<option value="${s.nome}">
${s.nome} — R$${s.preco}
</option>`;
});
}


// =======================
// INIT
// =======================

(function init(){
carregarSelects();
})();
// =======================
// CALENDÁRIO PREMIUM
// =======================

let calMes = new Date().getMonth();
let calAno = new Date().getFullYear();

function abrirCalendario(){
modalCal.classList.remove("hidden");
renderCalendario();
}

function fecharCalendario(){
modalCal.classList.add("hidden");
}


// ===== RENDER CALENDÁRIO =====

function renderCalendario(){

const meses = [
"Janeiro","Fevereiro","Março","Abril","Maio","Junho",
"Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
];

calTitulo.innerHTML = `
<div style="display:flex;justify-content:space-between;align-items:center;">
<button onclick="calMesAnt()">◀</button>
<b>${meses[calMes]} ${calAno}</b>
<button onclick="calMesProx()">▶</button>
</div>
`;

calGrid.innerHTML = "";

const primeiroDia = new Date(calAno,calMes,1).getDay();
const diasMes = new Date(calAno,calMes+1,0).getDate();

for(let i=0;i<primeiroDia;i++){
calGrid.innerHTML += "<div></div>";
}

for(let d=1; d<=diasMes; d++){

const dataObj = new Date(calAno,calMes,d);
const hoje = new Date();
hoje.setHours(0,0,0,0);

const passado = dataObj < hoje;
const ds = dataObj.toISOString().slice(0,10);

calGrid.innerHTML += `
<div class="calCell ${dataSel===ds?'sel':''}"
style="opacity:${passado?0.35:1}"
onclick="${passado?'':`selData('${ds}')`}">
${d}
</div>
`;

}
}


// ===== SELECIONAR DATA =====

function selData(ds){

dataSel = ds;
dataView.value = ds;

fecharCalendario();
}


// ===== NAVEGAÇÃO =====

function calMesAnt(){
calMes--;
if(calMes<0){
calMes=11;
calAno--;
}
renderCalendario();
}

function calMesProx(){
calMes++;
if(calMes>11){
calMes=0;
calAno++;
}
renderCalendario();
}
// =======================
// RELÓGIO HORÁRIOS
// =======================

function abrirRelogio(){

if(!dataSel){
alert("Escolha a data primeiro");
return;
}

modalClock.classList.remove("hidden");
renderRelogio();
}

function fecharRelogio(){
modalClock.classList.add("hidden");
}


// ===== RENDER RELÓGIO =====

function renderRelogio(){

clockGrid.innerHTML = "";

const lista = dbGet("agendamentos",[]);
const limite = dbGet("config",{}).limite || 2;

const disp = dbGet("disponibilidade",[]);
const dia = disp.find(x=>x.data===dataSel);

if(!dia || dia.horas.length===0){
clockGrid.innerHTML = "<div>Nenhum horário liberado</div>";
return;
}

dia.horas.sort().forEach(hora=>{

const qtd = lista.filter(a =>
a.data===dataSel &&
a.hora===hora &&
a.status==="ativo"
).length;

let cls="clockBtn";
if(qtd>=limite) cls+=" off";
if(horaSel===hora) cls+=" sel";

clockGrid.innerHTML += `
<div class="${cls}"
onclick="selHora('${hora}',${qtd>=limite})">
${hora}
</div>
`;

});
}


// ===== SELECIONAR HORA =====

function selHora(h,off){
if(off) return;
horaSel = h;
horaView.value = h;
renderRelogio();
}



// =======================
// DISPONIBILIDADE ADMIN
// =======================

if(typeof admDataDisp !== "undefined"){
admDataDisp.onchange = listarDispAdmin;
}

function addHoraDisponivel(){

const d = admDataDisp.value;
const h = admHoraDisp.value;

if(!d || !h){
alert("Escolha data e hora");
return;
}

let disp = dbGet("disponibilidade",[]);
let dia = disp.find(x=>x.data===d);

if(!dia){
dia = {data:d,horas:[]};
disp.push(dia);
}

if(!dia.horas.includes(h)){
dia.horas.push(h);
}

dbSet("disponibilidade",disp);
listarDispAdmin();
}


function listarDispAdmin(){

if(!admDataDisp.value) return;

const d = admDataDisp.value;
const disp = dbGet("disponibilidade",[]);
const dia = disp.find(x=>x.data===d);

listaDisp.innerHTML="";

(dia?.horas || []).sort().forEach(h=>{

listaDisp.innerHTML += `
<div class="item">
${h}
<button onclick="remHoraDisp('${d}','${h}')">Remover</button>
</div>
`;

});
}


function remHoraDisp(d,h){

let disp = dbGet("disponibilidade",[]);

disp = disp.map(x=>{
if(x.data===d){
x.horas = x.horas.filter(y=>y!==h);
}
return x;
});

dbSet("disponibilidade",disp);
listarDispAdmin();
}
// =======================
// HELPERS TEMPO
// =======================

function toMin(h){
const [hh,mm] = h.split(":");
return parseInt(hh)*60 + parseInt(mm);
}

function getServico(nome){
return dbGet("servicos",[])
.find(s=>s.nome===nome);
}


// =======================
// CONFIRMAR AGENDAMENTO
// =======================

function confirmarAgendamento(){

if(!dataSel || !horaSel){
alert("Escolha data e horário");
return;
}

const barb = barbeiro.value;
const serv = servico.value;
const nome = localStorage.getItem("cliNome");
const tel  = localStorage.getItem("cliTel");

const lista = dbGet("agendamentos",[]);
const cfg = dbGet("config",{});
const limite = cfg.limite || 2;
const buffer = cfg.buffer || 5;


// ===== DISPONIBILIDADE =====

const disp = dbGet("disponibilidade",[]);
const dia = disp.find(x=>x.data===dataSel);

if(!dia || !dia.horas.includes(horaSel)){
alert("Horário não disponível");
return;
}


// ===== LIMITE ENCAIXE =====

const qtd = lista.filter(a =>
a.data===dataSel &&
a.hora===horaSel &&
a.status==="ativo"
).length;

if(qtd >= limite){
alert("Horário lotado");
return;
}


// ===== CONFLITO POR DURAÇÃO =====

const servObj = getServico(serv);
const dur = servObj?.duracao || 30;

const ini1 = toMin(horaSel);
const fim1 = ini1 + dur + buffer;

const conflito = lista.some(a=>{

if(a.data!==dataSel) return false;
if(a.barbeiro!==barb) return false;
if(a.status!=="ativo") return false;

const s2 = getServico(a.servico);
const dur2 = s2?.duracao || 30;

const ini2 = toMin(a.hora);
const fim2 = ini2 + dur2 + buffer;

return (ini1 < fim2 && fim1 > ini2);

});

if(conflito){
alert("Conflito de horário pela duração");
return;
}


// ===== SALVAR =====

lista.push({
id: Date.now(),
nome:nome,
tel:tel,
barbeiro:barb,
servico:serv,
data:dataSel,
hora:horaSel,
status:"ativo",
criado:Date.now()
});

dbSet("agendamentos",lista);

alert("Agendamento confirmado");

listarMeus();
listarAgendaAdmin();
fecharRelogio();
}
// =======================
// LISTA CLIENTE
// =======================

function listarMeus(){

const tel = localStorage.getItem("cliTel");
const lista = dbGet("agendamentos",[]);

listaMeus.innerHTML = "";

lista
.filter(a => a.tel===tel && a.status==="ativo")
.sort((a,b)=>(a.data+a.hora).localeCompare(b.data+b.hora))
.forEach(a=>{

const s = getServico(a.servico);

listaMeus.innerHTML += `
<div class="item">
<b>${a.data}</b> • ${a.hora}<br>
${a.servico} — ${a.barbeiro}<br>
R$ ${s?.preco || 0}
<button onclick="cancelarAg(${a.id})">Cancelar</button>
</div>
`;

});
}



// =======================
// CANCELAR
// =======================

function cancelarAg(id){

let lista = dbGet("agendamentos",[]);

lista = lista.map(a=>{
if(a.id===id){
a.status="cancelado";
}
return a;
});

dbSet("agendamentos",lista);

listarMeus();
listarAgendaAdmin();
}



// =======================
// AGENDA ADMIN
// =======================

function listarAgendaAdmin(){

if(typeof agendaAdmin === "undefined") return;

const lista = dbGet("agendamentos",[]);

agendaAdmin.innerHTML = "";

lista
.filter(a=>a.status==="ativo")
.sort((a,b)=>(a.data+a.hora).localeCompare(b.data+b.hora))
.forEach(a=>{

const s = getServico(a.servico);

agendaAdmin.innerHTML += `
<div class="item">
${a.data} ${a.hora}<br>
${a.nome} — ${a.servico}<br>
${a.barbeiro} • R$ ${s?.preco || 0}
</div>
`;

});
}
// =======================
// ADMIN — CONFIG
// =======================

function salvarConfig(){

const cfg = dbGet("config",{});

cfg.limite = parseInt(cfgLimite.value) || 2;
cfg.buffer = cfg.buffer || 5;

dbSet("config",cfg);

alert("Config salva");
}



// =======================
// ADMIN — BARBEIROS
// =======================

function addBarbeiro(){

const nome = novoBarbeiro.value.trim();
if(!nome) return;

const l = dbGet("barbeiros",[]);
l.push(nome);
dbSet("barbeiros",l);

novoBarbeiro.value="";

listarBarbeirosAdmin();
carregarSelects();
}

function listarBarbeirosAdmin(){

if(typeof listaBarbeiros === "undefined") return;

const l = dbGet("barbeiros",[]);
listaBarbeiros.innerHTML="";

l.forEach((b,i)=>{
listaBarbeiros.innerHTML += `
<div class="item">
${b}
<button onclick="delBarbeiro(${i})">Excluir</button>
</div>`;
});
}

function delBarbeiro(i){

const l = dbGet("barbeiros",[]);
l.splice(i,1);
dbSet("barbeiros",l);

listarBarbeirosAdmin();
carregarSelects();
}



// =======================
// ADMIN — SERVIÇOS
// =======================

function addServico(){

const nome = novoServico.value.trim();
if(!nome) return;

const preco = parseFloat(prompt("Preço")) || 35;
const dur = parseInt(prompt("Duração minutos")) || 30;

const l = dbGet("servicos",[]);
l.push({
nome:nome,
preco:preco,
duracao:dur
});

dbSet("servicos",l);

novoServico.value="";

listarServicosAdmin();
carregarSelects();
}

function listarServicosAdmin(){

if(typeof listaServicos === "undefined") return;

const l = dbGet("servicos",[]);
listaServicos.innerHTML="";

l.forEach((s,i)=>{
listaServicos.innerHTML += `
<div class="item">
${s.nome} — R$${s.preco} — ${s.duracao}min
<button onclick="delServico(${i})">Excluir</button>
</div>`;
});
}

function delServico(i){

const l = dbGet("servicos",[]);
l.splice(i,1);
dbSet("servicos",l);

listarServicosAdmin();
carregarSelects();
}



// =======================
// CARREGAR ADMIN
// =======================

function carregarAdmin(){

const cfg = dbGet("config",{});
cfgLimite.value = cfg.limite || 2;

listarBarbeirosAdmin();
listarServicosAdmin();
listarAgendaAdmin();
listarDispAdmin();
}



// =======================
// AUTO CANCELAMENTO
// =======================

setInterval(()=>{

let l = dbGet("agendamentos",[]);
let mudou = false;

l.forEach(a=>{
if(a.status==="ativo"){
if(Date.now() - a.criado > 30*60*1000){
a.status="cancelado_auto";
mudou = true;
}
}
});

if(mudou){
dbSet("agendamentos",l);
listarMeus();
listarAgendaAdmin();
}

},60000);

</script>

</body>
</html>
