<!-- ========================= BLOCO 1 ========================= -->
<!DOCTYPE html>
<html lang="pt-br">
<head>

<meta charset="UTF-8">

<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>BARBARUJO ‚Ä¢ Agendamento</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e0e0e">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">

<style>

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:Poppins,sans-serif;
-webkit-tap-highlight-color: transparent;
user-select:none;
-webkit-user-select:none;
}

input, textarea{
user-select:text;
-webkit-user-select:text;
}

body{
background:#0e0e0e;
color:#fff;
overscroll-behavior:none;
}

header{
background:#111;
padding:20px;
text-align:center;
font-size:22px;
font-weight:800;
border-bottom:1px solid #222;
position:sticky;
top:0;
z-index:50;
letter-spacing:.5px;
}

.btn-back{
position:fixed;
left:14px;
top:14px;
z-index:9999;
background:#1c1c1c;
border:1px solid #333;
color:#fff;
width:42px;
height:42px;
border-radius:14px;
font-size:18px;
font-weight:900;
display:flex;
align-items:center;
justify-content:center;
}

.admin-fab{
position:fixed;
top:14px;
right:14px;
width:46px;
height:46px;
border-radius:14px;
background:linear-gradient(135deg,#d4af37,#f1d77a);
color:#000;
display:flex;
align-items:center;
justify-content:center;
font-size:20px;
font-weight:900;
z-index:9999;
}

.container{
max-width:1000px;
margin:auto;
padding:28px 18px 120px 18px;
display:none;
}

.card{
background:#171717;
border-radius:22px;
padding:28px;
margin-bottom:28px;
box-shadow:0 10px 30px rgba(0,0,0,.45);
border:1px solid #232323;
}

.card-sub{
background:#141414;
border:1px solid #262626;
}

.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:16px;
}

.btn{
background:linear-gradient(135deg,#d4af37,#f1d77a);
border:none;
padding:16px;
border-radius:16px;
font-weight:800;
width:100%;
color:#000;
font-size:15px;
}

.btn-outline{
background:transparent;
border:2px solid #d4af37;
color:#d4af37;
padding:14px;
border-radius:16px;
width:100%;
font-weight:800;
}

.btn-dark{
background:#242424;
border:1px solid #333;
color:#fff;
}

.btn-danger{
background:#402020;
border:2px solid #803030;
color:#ffb3b3;
}

input,select{
width:100%;
padding:16px;
border-radius:14px;
border:none;
margin-top:8px;
margin-bottom:14px;
color:#000;
font-size:15px;
}

.price{
font-size:22px;
font-weight:900;
background:linear-gradient(135deg,#d4af37,#ffe38a);
color:#000;
padding:8px 14px;
border-radius:14px;
display:inline-block;
margin-top:10px;
box-shadow:0 8px 22px rgba(212,175,55,.35);
}

.slot{
background:#202020;
padding:14px;
border-radius:14px;
text-align:center;
font-weight:800;
border:1px solid #2b2b2b;
cursor:pointer;
}

.slot.selected{
border:2px solid #d4af37;
background:#2b2616;
}

.slot.booked{
background:#402020;
opacity:.45;
pointer-events:none;
}

.splash{
position:fixed;
inset:0;
background:#0e0e0e;
display:flex;
flex-direction:column;
align-items:center;
justify-content:flex-start;
z-index:99999;
padding:24px;
padding-top:20px;
text-align:center;
}

.splash-logo{
display:block;
width:84vw;
max-width:540px;
height:auto;
margin:30px auto 8px auto;
background:transparent;
border:none;
box-shadow:none;
transform: translateX(-6vw);
object-fit:contain;
}

.hidden{display:none}

.pagamento-box{
background:#141414;
border:1px solid #262626;
border-radius:16px;
padding:16px;
margin-top:16px;
}

.pagamento-grid{
display:grid;
grid-template-columns:repeat(2,1fr);
gap:12px;
margin-top:10px;
}

.pagamento-btn{
background:#202020;
border:1px solid #333;
border-radius:14px;
padding:12px;
font-weight:800;
text-align:center;
cursor:pointer;
}

.pagamento-btn.sel{
border:2px solid #d4af37;
background:#2b2616;
}

.pix-box{
margin-top:12px;
padding:12px;
border-radius:12px;
background:#1a1a1a;
border:1px dashed #d4af37;
font-size:14px;
line-height:1.5;
}

.relatorio-btn{
background:linear-gradient(135deg,#2e7d32,#66bb6a);
color:#fff;
border:none;
padding:16px;
border-radius:16px;
font-weight:900;
width:100%;
margin-bottom:12px;
}

</style>
</head>
<body>
<!-- ========================= BLOCO 2 ========================= -->
<button id="btnBack" class="btn-back hidden">‚Üê</button>
<div id="btnAdminFab" class="admin-fab">‚öôÔ∏è</div>

<div id="telaSplash" class="splash">

<img src="logo.png" class="splash-logo">

<h1 style="
font-size:34px;
font-weight:900;
letter-spacing:.6px;
margin-bottom:10px;
margin-top:-60px;
">
üíà BARBARUJO
</h1>

<div style="
opacity:.9;
margin-bottom:22px;
font-size:14px;
line-height:1.6;
">

<b>Hor√°rio de atendimento</b><br><br>

Seg‚ÄìSex<br>
09:00‚Äì12:00<br>
14:00‚Äì19:00<br><br>

S√°bado<br>
09:00‚Äì17:00<br><br>

Domingo ‚Äî Fechado

</div>

<button id="btnEntrar" class="btn" style="max-width:360px">
Agendar hor√°rio
</button>

<button id="btnModoBarbeiro" class="btn btn-dark"
style="max-width:360px;margin-top:12px">
Sou barbeiro
</button>

</div>

<header id="topo">üíà BARBARUJO</header>

<div class="container">

<!-- ================= CLIENTE ================= -->

<div id="telaCliente">

<div class="card" id="cardServico">
<div class="step">PASSO 1</div>
<h3>Escolha o servi√ßo</h3>
<div id="listaServicos" class="grid"></div>
</div>

<div id="cardBarbeiro" class="card hidden">
<div class="step">PASSO 2</div>
<h3>Escolha o barbeiro</h3>
<div id="listaBarbeiros" class="grid"></div>
</div>

<div id="cardData" class="card hidden">
<div class="step">PASSO 3</div>
<h3>Escolha o dia</h3>

<select id="dataEscolhida"></select>

<button id="btnConfirmarData" class="btn-dark btn">
Ver hor√°rios deste dia
</button>
</div>

<div id="cardHorarios" class="card hidden">
<div class="step">PASSO 4</div>
<h3>Escolha o hor√°rio</h3>
<div id="listaHorarios" class="grid"></div>
</div>

<div id="cardCliente" class="card hidden">

<div class="step">PASSO 5</div>
<h3>Confirmar reserva</h3>

<div id="resumoEscolha"></div>

<input id="clienteNome" placeholder="Nome">
<input id="clienteFone" placeholder="WhatsApp">

<div id="boxPagamento" class="pagamento-box hidden">

<b>Forma de pagamento</b>

<div class="pagamento-grid">
<div class="pagamento-btn" data-pg="pix">PIX</div>
<div class="pagamento-btn" data-pg="debito">D√©bito</div>
<div class="pagamento-btn" data-pg="credito">Cr√©dito</div>
<div class="pagamento-btn" data-pg="dinheiro">Dinheiro</div>
</div>

<div id="pixInfo" class="pix-box hidden">
<b>Pagamento via PIX</b><br>
Chave: <span id="pixChaveView">49999538762</span><br>
Valor: R$ <span id="pixValorView">0,00</span><br><br>

<button id="btnCopiarPix" class="btn-outline">
Copiar chave PIX
</button>

<button id="btnPixPago" class="btn" style="margin-top:10px">
J√° paguei o PIX
</button>

</div>

</div>

<button id="btnReservar" class="btn">
Reservar hor√°rio
</button>

</div>

</div>

<!-- ================= ADMIN ================= -->

<div id="telaAdmin" class="hidden">

<div class="card card-sub">
<h3>Painel administrador</h3>

<button id="btnLogout" class="btn-outline">
Sair do painel
</button>

</div>

<div class="card">
<h3>Relat√≥rios de vendas</h3>

<button id="btnRelHoje" class="relatorio-btn">
Relat√≥rio de hoje
</button>

<div id="relHoje" style="margin-top:16px"></div>

</div>

<div class="card">
<h3>Servi√ßos</h3>

<input id="novoServicoNome" placeholder="Nome do servi√ßo">
<input id="novoServicoPreco" placeholder="Pre√ßo">

<button id="btnAddServico" class="btn">
Adicionar servi√ßo
</button>

<div id="adminServicos"></div>
</div>

<div class="card">
<h3>Barbeiros</h3>

<input id="novoBarbeiro" placeholder="Nome do barbeiro">

<button id="btnAddBarbeiro" class="btn">
Adicionar barbeiro
</button>

<div id="adminBarbeiros"></div>
</div>

<div class="card">
<h3>Disponibilidade</h3>

<label>Barbeiro</label>
<select id="adminBarbeiroSel"></select>

<label>Data</label>
<input type="date" id="adminDataPick">

<button id="btnGerarSlots" class="btn-dark btn">
Gerar hor√°rios
</button>

<div id="adminSlotsGrid" class="grid"></div>

<button id="btnSalvarSlotsDia" class="btn">
Salvar hor√°rios
</button>

</div>

<div class="card">
<h3>Todos agendamentos</h3>
<div id="listaAgendamentos"></div>
</div>

</div>
<!-- ========================= BLOCO 3 ========================= -->
<!-- FIREBASE + ESTADO GLOBAL + HELPERS -->

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>

const firebaseConfig = {
apiKey: "AIzaSyBDffb23AqSOoT-8Z94Ao9leB5nTSdIv78",
authDomain: "agenda-barbarujo.firebaseapp.com",
databaseURL: "https://agenda-barbarujo-default-rtdb.firebaseio.com/",
projectId: "agenda-barbarujo",
storageBucket: "agenda-barbarujo.firebasestorage.app",
messagingSenderId: "735138068544",
appId: "1:735138068544:web:5a1273bd8be9ef7ab487a5"
}

firebase.initializeApp(firebaseConfig)

const db = firebase.database()

const DB = {
servicos: db.ref("barbarujo/servicos"),
barbeiros: db.ref("barbarujo/barbeiros"),
ag: db.ref("barbarujo/agendamentos"),
disp: db.ref("barbarujo/disponibilidade"),
vendas: db.ref("barbarujo/vendas")
}

// ================= ESTADO =================

let servicos=[]
let barbeiros=[]
let disponibilidade={}
let agendamentos=[]
let agendamentosMap={}

let servicoSel=null
let barbeiroSel=null
let dataSel=null
let horaSel=null
let pagamentoSel=null
let servicosMulti=[]
let pixConfirmado=false

const PIX_CHAVE="49999538762"
const WHATS_LOJA="5549999538762"

// ================= HELPERS =================

function hojeISO(){
return new Date().toISOString().split("T")[0]
}

function formatarPreco(v){
return Number(v||0).toFixed(2).replace(".",",")
}

function rolarPara(el){
if(!el) return
setTimeout(()=>el.scrollIntoView({behavior:"smooth"}),120)
}

// ================= NAV =================

btnEntrar.onclick=()=>{
telaSplash.style.display="none"
document.querySelector(".container").style.display="block"
telaCliente.classList.remove("hidden")
btnBack.classList.remove("hidden")
}

btnAdminFab.onclick=()=>{
let s = prompt("Senha admin")
if(s!=="barbarujo123") return
telaCliente.classList.add("hidden")
telaAdmin.classList.remove("hidden")
btnBack.classList.remove("hidden")
}

btnBack.onclick=()=>{
telaAdmin.classList.add("hidden")
telaCliente.classList.remove("hidden")
}

// ================= TELEFONE =================

clienteFone.addEventListener("input",()=>{
clienteFone.value =
clienteFone.value.replace(/\D/g,"").slice(0,11)
})

</script>
<!-- ========================= BLOCO 4 ========================= -->
<!-- CLIENTE ‚Äî SERVI√áOS / BARBEIROS / DATAS / HOR√ÅRIOS -->

<script>

// ================= SERVI√áOS =================

function renderServicos(){

listaServicos.innerHTML=""

servicos.forEach(s=>{

let b=document.createElement("button")
b.className="btn"

let ja = servicosMulti.find(x=>x.nome===s.nome)

b.innerHTML=`
<div style="font-weight:800">${s.nome}</div>
<div class="price">R$ ${formatarPreco(s.preco)}</div>
${ja?"<div style='font-size:12px;margin-top:6px'>‚úî selecionado</div>":""}
`

b.onclick=()=>{

servicoSel=s

let i=servicosMulti.findIndex(x=>x.nome===s.nome)
if(i>=0){ servicosMulti.splice(i,1) }
else{ servicosMulti.push(s) }

cardBarbeiro.classList.remove("hidden")
renderBarbeiros()
rolarPara(cardBarbeiro)

renderServicos()
}

listaServicos.appendChild(b)

})

}

// ================= BARBEIROS =================

function renderBarbeiros(){

listaBarbeiros.innerHTML=""

barbeiros.forEach(b=>{

let nome=b.nome||b

let btn=document.createElement("button")
btn.className="btn-outline"
btn.innerText=nome

btn.onclick=()=>{
barbeiroSel=nome
cardData.classList.remove("hidden")
renderDatas()
rolarPara(cardData)
}

listaBarbeiros.appendChild(btn)

})

}

// ================= DATAS =================

function renderDatas(){

dataEscolhida.innerHTML=""

let dias = Object.keys(disponibilidade[barbeiroSel]||{}).sort()

if(!dias.length){
dataEscolhida.innerHTML="<option>Sem datas</option>"
return
}

dias.forEach(d=>{
let o=document.createElement("option")
o.value=d
o.textContent=d
dataEscolhida.appendChild(o)
})

}

btnConfirmarData.onclick=()=>{

dataSel=dataEscolhida.value
if(!dataSel) return

renderHorarios()
cardHorarios.classList.remove("hidden")
rolarPara(cardHorarios)

}

// ================= HOR√ÅRIOS =================

function renderHorarios(){

listaHorarios.innerHTML=""
horaSel=null

let lista =
(disponibilidade[barbeiroSel] &&
 disponibilidade[barbeiroSel][dataSel]) || []

lista.forEach(h=>{

let div=document.createElement("div")
div.className="slot"
div.innerText=h

let ocupado = agendamentos.find(a=>
a.data===dataSel &&
a.hora===h &&
a.barbeiro===barbeiroSel
)

if(ocupado) div.classList.add("booked")

div.onclick=()=>{

if(div.classList.contains("booked")) return

document.querySelectorAll(".slot")
.forEach(x=>x.classList.remove("selected"))

div.classList.add("selected")
horaSel=h

cardCliente.classList.remove("hidden")
atualizarResumo()
mostrarPagamento()
rolarPara(cardCliente)

}

listaHorarios.appendChild(div)

})

}

</script>
<!-- ========================= BLOCO 5 ========================= -->
<!-- CLIENTE ‚Äî RESUMO / PAGAMENTO / PIX / WHATSAPP / FINALIZAR -->

<script>

// ================= RESUMO =================

function totalSelecionado(){
if(servicosMulti.length){
return servicosMulti.reduce((t,s)=>t+Number(s.preco||0),0)
}
return Number(servicoSel?.preco||0)
}

function nomesSelecionados(){
if(servicosMulti.length){
return servicosMulti.map(s=>s.nome).join(", ")
}
return servicoSel?.nome||"-"
}

function atualizarResumo(){

let total = totalSelecionado()

resumoEscolha.innerHTML=`
<div class="card-sub" style="padding:16px">
<b>Servi√ßo(s):</b> ${nomesSelecionados()}<br>
<b>Barbeiro:</b> ${barbeiroSel||"-"}<br>
<b>Data:</b> ${dataSel||"-"}<br>
<b>Hora:</b> ${horaSel||"-"}<br>
<div class="price" style="margin-top:10px">
R$ ${formatarPreco(total)}
</div>
</div>
`

pixValorView.innerText = formatarPreco(total)

}

// ================= PAGAMENTO =================

let pixConfirmado=false

function mostrarPagamento(){

boxPagamento.classList.remove("hidden")

document.querySelectorAll(".pagamento-btn")
.forEach(btn=>{

btn.onclick=()=>{

document.querySelectorAll(".pagamento-btn")
.forEach(b=>b.classList.remove("sel"))

btn.classList.add("sel")
pagamentoSel = btn.dataset.pg

if(pagamentoSel==="pix"){
pixInfo.classList.remove("hidden")
}else{
pixInfo.classList.add("hidden")
pixConfirmado=false
}

}

})

}

// ================= PIX =================

btnCopiarPix.onclick=()=>{
navigator.clipboard.writeText(PIX_CHAVE)
alert("PIX copiado")
}

btnPixPago.onclick=()=>{
pixConfirmado=true
alert("PIX confirmado")
}

// ================= WHATS LOJA =================

function enviarWhatsLoja(ag){

let msg =
`üíà ${NOME_BARBEARIA}

NOVO AGENDAMENTO

Cliente: ${ag.cliente}
Whats: ${ag.fone}
Servi√ßo(s): ${ag.servico}
Barbeiro: ${ag.barbeiro}
Data: ${ag.data}
Hora: ${ag.hora}
Pagamento: ${ag.pagamento}
Valor: R$ ${formatarPreco(ag.preco)}
`

let url =
"https://wa.me/"+WHATS_LOJA+
"?text="+encodeURIComponent(msg)

let a=document.createElement("a")
a.href=url
a.target="_blank"
document.body.appendChild(a)
a.click()
a.remove()

}

// ================= FINALIZAR =================

btnReservar.onclick = async ()=>{

if(!servicoSel && !servicosMulti.length){
alert("Escolha servi√ßo"); return
}
if(!barbeiroSel){
alert("Escolha barbeiro"); return
}
if(!dataSel || !horaSel){
alert("Escolha hor√°rio"); return
}
if(!clienteNome.value || !clienteFone.value){
alert("Preencha dados"); return
}
if(!pagamentoSel){
alert("Escolha pagamento"); return
}
if(pagamentoSel==="pix" && !pixConfirmado){
alert("Confirme PIX"); return
}

let ag = {
servico: nomesSelecionados(),
preco: totalSelecionado(),
barbeiro: barbeiroSel,
data: dataSel,
hora: horaSel,
cliente: clienteNome.value,
fone: clienteFone.value,
pagamento: pagamentoSel,
ts: Date.now()
}

await DB.ag.push(ag)

DB.vendas
.child(ag.data)
.child(ag.pagamento)
.transaction(v=>(v||0)+ag.preco)

enviarWhatsLoja(ag)

alert("Agendado com sucesso")

location.reload()

}

</script>
<script>

// =====================================================
// ================= ADMIN ‚Äî SERVI√áOS ==================
// =====================================================

function renderAdminServicos(){

adminServicos.innerHTML=""

if(!servicos.length){
adminServicos.innerHTML="Sem servi√ßos"
return
}

servicos.forEach((s,i)=>{

let div=document.createElement("div")
div.className="card card-sub"

div.innerHTML=`

<div style="font-size:16px;font-weight:800">
${s.nome}
</div>

<div class="price">
R$ ${formatarPreco(s.preco)}
</div>

<button class="btn-danger btn"
onclick="removerServico(${i})"
style="margin-top:12px">
Excluir servi√ßo
</button>

`

adminServicos.appendChild(div)

})

}

btnAddServico.onclick=()=>{

if(!novoServicoNome.value || !novoServicoPreco.value){
alert("Preencha nome e pre√ßo")
return
}

servicos.push({
nome:novoServicoNome.value,
preco:Number(novoServicoPreco.value)
})

DB.servicos.set(servicos)

novoServicoNome.value=""
novoServicoPreco.value=""

alert("Servi√ßo adicionado")

}

function removerServico(i){

if(!confirm("Excluir servi√ßo?")) return

servicos.splice(i,1)
DB.servicos.set(servicos)

}

// =====================================================
// ================= ADMIN ‚Äî BARBEIROS =================
// =====================================================

function renderAdminBarbeiros(){

adminBarbeiros.innerHTML=""

if(!barbeiros.length){
adminBarbeiros.innerHTML="Sem barbeiros"
return
}

barbeiros.forEach((b,i)=>{

let nome=b.nome||b
let whats=b.whats||""

let div=document.createElement("div")
div.className="card card-sub"

div.innerHTML=`

<b>${nome}</b><br>
Whats atual: ${whats || "-"}

<input id="wb_${i}" placeholder="Whats barbeiro">

<button class="btn-dark btn"
onclick="salvarWhatsBarbeiro(${i})"
style="margin-top:10px">
Salvar Whats
</button>

<button class="btn-danger btn"
onclick="removerBarbeiro(${i})"
style="margin-top:10px">
Excluir barbeiro
</button>

`

adminBarbeiros.appendChild(div)

})

}

btnAddBarbeiro.onclick=()=>{

if(!novoBarbeiro.value){
alert("Digite o nome")
return
}

barbeiros.push({
nome:novoBarbeiro.value,
whats:""
})

DB.barbeiros.set(barbeiros)

novoBarbeiro.value=""

alert("Barbeiro adicionado")

}

function removerBarbeiro(i){

if(!confirm("Excluir barbeiro?")) return

barbeiros.splice(i,1)
DB.barbeiros.set(barbeiros)

}

function salvarWhatsBarbeiro(i){

let v=document
.getElementById("wb_"+i)
.value.replace(/\D/g,"")

if(v.length<10){
alert("Whats inv√°lido")
return
}

barbeiros[i].whats=v
DB.barbeiros.set(barbeiros)

alert("Whats salvo")

}

// =====================================================
// ================= ADMIN ‚Äî DISPONIBILIDADE ===========
// =====================================================

function popularSelectsBarbeiro(){

adminBarbeiroSel.innerHTML=""
resetBarbeiro.innerHTML=""
barbeiroModoSel.innerHTML=""
excBarbeiro.innerHTML=""

barbeiros.forEach(b=>{

let nome=b.nome||b

adminBarbeiroSel.add(new Option(nome,nome))
resetBarbeiro.add(new Option(nome,nome))
barbeiroModoSel.add(new Option(nome,nome))
excBarbeiro.add(new Option(nome,nome))

})

}

// =====================================================
// ================= GERADOR DE SLOTS ==================
// =====================================================

function blocosDiaSemana(dataISO){

let d = new Date(dataISO+"T00:00:00")
let dia = d.getDay()

if(dia===0) return []

if(dia===6){
return [["09:00","17:00"]]
}

return [
["09:00","12:00"],
["14:00","19:00"]
]

}

function gerarSlotsFixos(dataISO){

let blocos = blocosDiaSemana(dataISO)
let lista=[]
let intervalo = config.intervalo || 30

blocos.forEach(b=>{

let [ai,af]=b

let [ha,ma]=ai.split(":").map(Number)
let [hf,mf]=af.split(":").map(Number)

let ini=ha*60+ma
let fim=hf*60+mf

for(let t=ini;t<fim;t+=intervalo){

let h=Math.floor(t/60).toString().padStart(2,"0")
let m=(t%60).toString().padStart(2,"0")

lista.push(h+":"+m)

}

})

return lista

}

btnGerarSlots.onclick=()=>{

let barbeiro = adminBarbeiroSel.value
let data = adminDataPick.value

if(!barbeiro || !data){
alert("Escolha barbeiro e data")
return
}

let base = gerarSlotsFixos(data)

if(!base.length){
alert("Domingo fechado")
adminSlotsGrid.innerHTML=""
return
}

let ja =
(disponibilidade[barbeiro] &&
 disponibilidade[barbeiro][data]) || []

adminSlotsGrid.innerHTML=""

base.forEach(hora=>{

let div=document.createElement("div")
div.className="slot"
div.innerText=hora

if(ja.includes(hora)){
div.classList.add("selected")
}

div.onclick=()=>div.classList.toggle("selected")

adminSlotsGrid.appendChild(div)

})

rolarPara(adminSlotsGrid)

}

btnSalvarSlotsDia.onclick=()=>{

let barbeiro = adminBarbeiroSel.value
let data = adminDataPick.value

if(!barbeiro || !data){
alert("Escolha barbeiro e data")
return
}

let sel=[]

document
.querySelectorAll("#adminSlotsGrid .slot.selected")
.forEach(s=>sel.push(s.innerText))

if(!sel.length){
alert("Selecione hor√°rios")
return
}

DB.disp.child(barbeiro).child(data).set(sel)

alert("Disponibilidade salva")

adminSlotsGrid.innerHTML=""
adminDataPick.value=""

}

btnLimparGerador.onclick=()=>{
adminSlotsGrid.innerHTML=""
}

</script>
<script>

// =====================================================
// ================= RESET GUIADO DISP =================
// =====================================================

btnAbrirReset.onclick=()=>{

resetBox.classList.toggle("hidden")

if(!resetBox.classList.contains("hidden")){
renderResetDias()
rolarPara(resetBox)
}

}

resetBarbeiro.onchange = renderResetDias

function renderResetDias(){

resetDias.innerHTML=""
resetHorarios.innerHTML=""

let barbeiro = resetBarbeiro.value

if(!barbeiro){
resetDias.innerHTML="Escolha o barbeiro"
return
}

let diasObj = disponibilidade[barbeiro] || {}
let dias = Object.keys(diasObj).sort()

if(!dias.length){
resetDias.innerHTML="Sem dias cadastrados"
return
}

dias.forEach(d=>{

let b=document.createElement("button")
b.className="btn-dark btn"
b.style.marginBottom="10px"
b.textContent=d

b.onclick=()=>renderResetHorarios(barbeiro,d)

resetDias.appendChild(b)

})

}

// -----------------------------------------------------

function renderResetHorarios(barbeiro,data){

resetHorarios.innerHTML=""

let lista =
(disponibilidade[barbeiro] &&
 disponibilidade[barbeiro][data]) || []

if(!lista.length){
resetHorarios.innerHTML="Sem hor√°rios neste dia"
return
}

lista.forEach(h=>{

let div=document.createElement("div")
div.className="slot"
div.innerText=h

div.onclick=()=>div.classList.toggle("selected")

resetHorarios.appendChild(div)

})

resetHorarios.dataset.barbeiro = barbeiro
resetHorarios.dataset.data = data

rolarPara(resetHorarios)

}

// =====================================================
// ================= EXCLUIR SLOTS =====================
// =====================================================

btnExcluirSlots.onclick=()=>{

let barbeiro = resetHorarios.dataset.barbeiro
let data = resetHorarios.dataset.data

if(!barbeiro || !data){
alert("Escolha barbeiro e dia")
return
}

let remover=[]

document
.querySelectorAll("#resetHorarios .slot.selected")
.forEach(s=>remover.push(s.innerText))

if(!remover.length){
alert("Selecione hor√°rios")
return
}

if(!confirm("Excluir hor√°rios selecionados?"))
return

let atuais =
(disponibilidade[barbeiro] &&
 disponibilidade[barbeiro][data]) || []

let novos = atuais.filter(h=>!remover.includes(h))

DB.disp.child(barbeiro).child(data).set(novos)

alert("Hor√°rios removidos")

renderResetHorarios(barbeiro,data)

}

</script>
<script>

// =====================================================
// ================= TELA EXCLUS√ÉO =====================
// =====================================================

btnAbrirExclusao.onclick = ()=>{

telaAdmin.classList.add("hidden")
telaExclusao.classList.remove("hidden")

excBarbeiro.innerHTML=""

barbeiros.forEach(b=>{
let nome=b.nome||b
excBarbeiro.add(new Option(nome,nome))
})

rolarPara(telaExclusao)

}

btnCarregarExc.onclick=()=>{

let barb = excBarbeiro.value
let data = excData.value

if(!barb || !data){
alert("Escolha barbeiro e data")
return
}

listaExclusao.innerHTML=""

let lista = Object.entries(agendamentosMap)
.filter(([k,a])=> a.barbeiro===barb && a.data===data)
.sort((a,b)=>a[1].hora.localeCompare(b[1].hora))

if(!lista.length){
listaExclusao.innerHTML="Nenhum agendamento"
return
}

lista.forEach(([key,a])=>{

let div=document.createElement("div")
div.className="card card-sub"

div.innerHTML=`
<b>${a.hora}</b><br>
Cliente: ${a.cliente}<br>
Servi√ßo: ${a.servico}<br>
Pagamento: ${a.pagamento}<br>

<button class="btn-danger btn"
style="margin-top:10px"
onclick="excluirAgendamentoAdmin('${key}')">
Excluir
</button>
`

listaExclusao.appendChild(div)

})

}

// =====================================================
// ================= MODO BARBEIRO =====================
// =====================================================

function popularModoBarbeiro(){

barbeiroModoSel.innerHTML=""

barbeiros.forEach(b=>{
let nome=b.nome||b
barbeiroModoSel.add(new Option(nome,nome))
})

}

btnVoltarCliente.onclick=()=>{
telaBarbeiro.classList.add("hidden")
telaCliente.classList.remove("hidden")
}

btnVerAgendaBarbeiro.onclick = renderAgendaBarbeiro

function renderAgendaBarbeiro(){

let nome = barbeiroModoSel.value
let data = barbeiroModoData.value || hojeISO()

listaBarbeiroAgenda.innerHTML=""

let lista = agendamentos
.filter(a=>a.barbeiro===nome && a.data===data)
.sort((a,b)=>a.hora.localeCompare(b.hora))

if(!lista.length){
listaBarbeiroAgenda.innerHTML="Sem clientes"
return
}

lista.forEach(a=>{

let div=document.createElement("div")
div.className="card card-sub"

div.innerHTML=`
<b>${a.hora}</b><br>
${a.cliente}<br>
${a.servico}<br>

<button class="btn-dark btn"
onclick="window.open('https://wa.me/55${a.fone}','_blank')">
WhatsApp
</button>
`

listaBarbeiroAgenda.appendChild(div)

})

}

// =====================================================
// ================= RELAT√ìRIO PER√çODO =================
// =====================================================

btnRelPeriodo.onclick=()=>{

relatorioBox.classList.remove("hidden")

relatorioBox.innerHTML=`

<select id="relTipoSel">
<option value="dia">Dia</option>
<option value="mes">M√™s</option>
<option value="ano">Ano</option>
</select>

<div id="relRefWrap" style="margin-top:10px"></div>

<button id="btnGerarRelPeriodo" class="btn" style="margin-top:10px">
Gerar
</button>

<div id="relPeriodoResultado" style="margin-top:14px"></div>

`

configurarRelRefUI()

relTipoSel.onchange=configurarRelRefUI
btnGerarRelPeriodo.onclick=gerarRelatorioPeriodoUI

}

function configurarRelRefUI(){

let tipo = relTipoSel.value

if(tipo==="dia"){
relRefWrap.innerHTML=`<input type="date" id="relRefInput">`
return
}

if(tipo==="mes"){

let ano=new Date().getFullYear()

relRefWrap.innerHTML=`
<select id="relMesSel">
<option value="01">Jan</option>
<option value="02">Fev</option>
<option value="03">Mar</option>
<option value="04">Abr</option>
<option value="05">Mai</option>
<option value="06">Jun</option>
<option value="07">Jul</option>
<option value="08">Ago</option>
<option value="09">Set</option>
<option value="10">Out</option>
<option value="11">Nov</option>
<option value="12">Dez</option>
</select>
<select id="relAnoSel"></select>
`

for(let a=2026;a<=ano+5;a++){
relAnoSel.add(new Option(a,a))
}

return
}

if(tipo==="ano"){

let ano=new Date().getFullYear()

relRefWrap.innerHTML=`<select id="relAnoUnico"></select>`

for(let a=2026;a<=ano+5;a++){
relAnoUnico.add(new Option(a,a))
}

}

}

function gerarRelatorioPeriodoUI(){

let tipo = relTipoSel.value
let lista=[]

if(tipo==="dia"){
let d=relRefInput.value
lista=agendamentos.filter(a=>a.data===d)
}

if(tipo==="mes"){
let ref=relAnoSel.value+"-"+relMesSel.value
lista=agendamentos.filter(a=>a.data.startsWith(ref))
}

if(tipo==="ano"){
lista=agendamentos.filter(a=>a.data.startsWith(relAnoUnico.value))
}

let total=0

lista.forEach(a=> total+=Number(a.preco||0))

relPeriodoResultado.innerHTML=`
<div class="price">
Total: R$ ${formatarPreco(total)}
</div>
`

}

</script>

</div>
</body>
</html>
