<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <title>BARBARUJO ‚Ä¢ Agendamento</title>

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0e0e0e" />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;900&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Poppins, sans-serif;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        -webkit-user-select: none;
      }

      input,
      textarea {
        user-select: text;
        -webkit-user-select: text;
      }

      body {
        background: #0e0e0e;
        color: #fff;
        overscroll-behavior: none;
      }

      header {
        background: #111;
        padding: 20px;
        text-align: center;
        font-size: 22px;
        font-weight: 800;
        border-bottom: 1px solid #222;
        position: sticky;
        top: 0;
        z-index: 50;
        letter-spacing: 0.5px;
      }

      .btn-back {
        position: fixed;
        left: 14px;
        top: 14px;
        z-index: 9999;
        background: #1c1c1c;
        border: 1px solid #333;
        color: #fff;
        width: 42px;
        height: 42px;
        border-radius: 14px;
        font-size: 18px;
        font-weight: 900;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .admin-fab {
        position: fixed;
        top: 14px;
        right: 14px;
        width: 46px;
        height: 46px;
        border-radius: 14px;
        background: linear-gradient(135deg, #d4af37, #f1d77a);
        color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 900;
        z-index: 9999;
      }

      .container {
        max-width: 1000px;
        margin: auto;
        padding: 28px 18px 120px 18px;
        display: none;
      }

      .card {
        background: #171717;
        border-radius: 22px;
        padding: 28px;
        margin-bottom: 28px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
        border: 1px solid #232323;
      }

      .card-sub {
        background: #141414;
        border: 1px solid #262626;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .btn {
        background: linear-gradient(135deg, #d4af37, #f1d77a);
        border: none;
        padding: 16px;
        border-radius: 16px;
        font-weight: 800;
        width: 100%;
        color: #000;
        font-size: 15px;
      }

      .btn-outline {
        background: transparent;
        border: 2px solid #d4af37;
        color: #d4af37;
        padding: 14px;
        border-radius: 16px;
        width: 100%;
        font-weight: 800;
      }

      .btn-dark {
        background: #242424;
        border: 1px solid #333;
        color: #fff;
      }

      .btn-danger {
        background: #402020;
        border: 2px solid #803030;
        color: #ffb3b3;
      }

      input,
      select {
        width: 100%;
        padding: 16px;
        border-radius: 14px;
        border: none;
        margin-top: 8px;
        margin-bottom: 14px;
        color: #000;
        font-size: 15px;
      }

      .price {
        font-size: 22px;
        font-weight: 900;
        background: linear-gradient(135deg, #d4af37, #ffe38a);
        color: #000;
        padding: 8px 14px;
        border-radius: 14px;
        display: inline-block;
        margin-top: 10px;
        box-shadow: 0 8px 22px rgba(212, 175, 55, 0.35);
      }

      .slot {
        background: #202020;
        padding: 14px;
        border-radius: 14px;
        text-align: center;
        font-weight: 800;
        border: 1px solid #2b2b2b;
        cursor: pointer;
      }

      .slot.selected {
        border: 2px solid #d4af37;
        background: #2b2616;
      }

      .slot.booked {
        background: #402020;
        opacity: 0.45;
        pointer-events: none;
      }

      .splash {
        position: fixed;
        inset: 0;
        background: #0e0e0e;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        z-index: 99999;
        padding: 24px;
        padding-top: 20px;
        padding-bottom: env(safe-area-inset-bottom, 20px);
        text-align: center;
        height: 100dvh;
        height: 100vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      @supports (height: 100dvh) {
        .splash {
          height: 100dvh;
        }
      }

      .splash-logo {
        display: block;
        width: 70vw;
        max-width: 400px;
        height: auto;
        margin: 15px auto 8px auto;
        background: transparent;
        border: none;
        box-shadow: none;
        transform: translateX(-4vw);
        object-fit: contain;
        flex-shrink: 0;
      }

      .hidden {
        display: none;
      }

      /* PAGAMENTO */

      .pagamento-box {
        background: #141414;
        border: 1px solid #262626;
        border-radius: 16px;
        padding: 16px;
        margin-top: 16px;
      }

      .pagamento-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 10px;
      }

      .pagamento-btn {
        background: #202020;
        border: 1px solid #333;
        border-radius: 14px;
        padding: 12px;
        font-weight: 800;
        text-align: center;
        cursor: pointer;
      }

      .pagamento-btn.sel {
        border: 2px solid #d4af37;
        background: #2b2616;
      }

      .pix-box {
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        background: #1a1a1a;
        border: 1px dashed #d4af37;
        font-size: 14px;
        line-height: 1.5;
      }

      .relatorio-btn {
        background: linear-gradient(135deg, #2e7d32, #66bb6a);
        color: #fff;
        border: none;
        padding: 16px;
        border-radius: 16px;
        font-weight: 900;
        width: 100%;
        margin-bottom: 12px;
      }
    </style>
  </head>
  <body>
    <button id="btnBack" class="btn-back hidden">‚Üê</button>
    <div id="btnAdminFab" class="admin-fab">‚öôÔ∏è</div>

    <!-- SPLASH -->

    <div id="telaSplash" class="splash">
      <img src="logo.png" class="splash-logo" />

      <h1
        style="
          font-size: 30px;
          font-weight: 900;
          margin-bottom: 8px;
          margin-top: -40px;
        "
      >
        üíà BARBARUJO
      </h1>

      <div
        style="
          opacity: 0.9;
          margin-bottom: 16px;
          font-size: 13px;
          line-height: 1.5;
        "
      >
        <b>Hor√°rio de atendimento</b><br /><br />
        Seg‚ÄìSex: 09:00‚Äì12:00 / 14:00‚Äì19:00<br />
        S√°bado: 09:00‚Äì17:00<br />
        Domingo ‚Äî Fechado
      </div>

      <button id="btnEntrar" class="btn" style="max-width: 360px">
        Agendar hor√°rio
      </button>

      <button
        id="btnModoBarbeiro"
        class="btn btn-dark"
        style="max-width: 360px; margin-top: 12px; margin-bottom: 30px"
      >
        Sou barbeiro
      </button>
    </div>

    <header id="topo">üíà BARBARUJO</header>

    <div class="container">
      <!-- ================= CLIENTE ================= -->

      <div id="telaCliente">
        <div class="card" id="cardServico">
          <div class="step">PASSO 1</div>
          <h3>Escolha o servi√ßo</h3>
          <div id="listaServicos" class="grid"></div>
        </div>

        <div id="cardServicosSel" class="card hidden">
          <h3>Servi√ßos selecionados</h3>
          <div id="listaServicosSel"></div>
          <button id="btnLimparServicos" class="btn-outline">
            Limpar servi√ßos
          </button>
        </div>

        <div id="cardBarbeiro" class="card hidden">
          <div class="step">PASSO 2</div>
          <h3>Escolha o barbeiro</h3>
          <div id="listaBarbeiros" class="grid"></div>
        </div>

        <div id="cardData" class="card hidden">
          <div class="step">PASSO 3</div>
          <h3>Escolha o dia</h3>

          <select id="dataEscolhida"></select>

          <button id="btnConfirmarData" class="btn-dark btn">
            Ver hor√°rios deste dia
          </button>
        </div>

        <div id="cardHorarios" class="card hidden">
          <div class="step">PASSO 4</div>
          <h3>Escolha o hor√°rio</h3>
          <div id="listaHorarios" class="grid"></div>
        </div>

        <div id="cardCliente" class="card hidden">
          <div class="step">PASSO 5</div>
          <h3>Confirmar reserva</h3>

          <div id="resumoEscolha"></div>

          <input id="clienteNome" placeholder="Nome" />
          <input id="clienteFone" placeholder="WhatsApp" />

          <div id="boxPagamento" class="pagamento-box hidden">
            <b>Forma de pagamento</b>

            <div class="pagamento-grid">
              <div class="pagamento-btn" data-pg="pix">PIX</div>
              <div class="pagamento-btn" data-pg="debito">D√©bito</div>
              <div class="pagamento-btn" data-pg="credito">Cr√©dito</div>
              <div class="pagamento-btn" data-pg="dinheiro">Dinheiro</div>
            </div>

            <div id="pixInfo" class="pix-box hidden">
              <b>Pagamento via PIX</b><br />
              Chave: <span id="pixChaveView">49999538762</span><br />
              Valor: R$ <span id="pixValorView">0,00</span><br /><br />

              <button id="btnCopiarPix" class="btn-outline">
                Copiar chave PIX
              </button>
            </div>
          </div>

          <button id="btnReservar" class="btn">Reservar hor√°rio</button>
        </div>
      </div>

      <!-- TELA CONFIRMA√á√ÉO PIX -->
      <div id="telaConfirmaPix" class="card hidden">
        <div class="step">PAGAMENTO</div>
        <h3>Confirma√ß√£o de PIX</h3>
        <p style="font-size: 14px; opacity: 0.8; margin-bottom: 15px">
          Para concluir sua reserva, realize o pagamento via PIX e clique no
          bot√£o abaixo para confirmar.
        </p>
        <div class="pix-box" style="margin-bottom: 15px">
          <b>Chave PIX:</b> <span id="pixChaveConfirm">49999538762</span><br />
          <b>Valor:</b> R$ <span id="pixValorConfirm">0,00</span><br />
          <button
            id="btnCopiarPixConfirm"
            class="btn-outline"
            style="margin-top: 10px; font-size: 12px; padding: 8px"
          >
            Copiar Chave
          </button>
        </div>
        <button id="btnJaFizPix" class="btn">J√° realizei o pagamento</button>
        <button
          id="btnVoltarPagamento"
          class="btn-outline"
          style="margin-top: 10px"
        >
          Alterar pagamento
        </button>
      </div>

      <!-- ================= MODO BARBEIRO ================= -->

      <div id="telaBarbeiro" class="hidden">
        <div class="card">
          <h3>Modo barbeiro</h3>

          <label>Seu nome</label>
          <select id="barbeiroModoSel"></select>

          <label>Data</label>
          <input type="date" id="barbeiroModoData" />

          <button id="btnVerAgendaBarbeiro" class="btn">
            Ver minha agenda
          </button>

          <button id="btnVoltarCliente" class="btn-outline">
            Voltar para cliente
          </button>
        </div>

        <div class="card">
          <h3>Clientes do dia</h3>
          <div id="listaBarbeiroAgenda"></div>
        </div>
      </div>

      <!-- ================= ADMIN ================= -->

      <div id="telaAdmin" class="hidden">
        <div class="card card-sub">
          <h3>Painel administrador</h3>
          <button id="btnLogout" class="btn-outline">Sair do painel</button>
        </div>

        <!-- RELAT√ìRIOS -->

        <div class="card">
          <h3>Relat√≥rios de vendas</h3>

          <button id="btnRelHoje" class="relatorio-btn">
            Relat√≥rio de hoje
          </button>

          <button id="btnRelPeriodo" class="btn-dark btn">
            Relat√≥rio por per√≠odo
          </button>

          <button
            id="btnZerarVendas"
            class="btn-danger btn"
            style="margin-top: 12px; font-size: 12px; padding: 10px"
          >
            Zerar todos os relat√≥rios
          </button>

          <div
            id="relHojeBox"
            class="card-sub hidden"
            style="margin-top: 16px"
          ></div>
          <div
            id="relPeriodoBox"
            class="card-sub hidden"
            style="margin-top: 16px"
          ></div>
        </div>

        <!-- SERVI√áOS -->

        <div class="card">
          <h3>Servi√ßos</h3>

          <input id="novoServicoNome" placeholder="Nome do servi√ßo" />
          <input id="novoServicoPreco" placeholder="Pre√ßo" />

          <button id="btnAddServico" class="btn">Adicionar servi√ßo</button>

          <div id="adminServicos"></div>
        </div>

        <!-- BARBEIROS -->

        <div class="card">
          <h3>Barbeiros</h3>

          <input id="novoBarbeiro" placeholder="Nome do barbeiro" />

          <button id="btnAddBarbeiro" class="btn">Adicionar barbeiro</button>

          <div id="adminBarbeiros"></div>
        </div>

        <!-- DISPONIBILIDADE -->

        <div class="card">
          <h3>Disponibilidade por barbeiro</h3>

          <label>Barbeiro</label>
          <select id="adminBarbeiroSel"></select>

          <label>Data</label>
          <input type="date" id="adminDataPick" />

          <button id="btnGerarSlots" class="btn-dark btn">
            Gerar hor√°rios base
          </button>

          <div id="adminSlotsGrid" class="grid"></div>

          <button id="btnSalvarSlotsDia" class="btn">
            Salvar disponibilidade
          </button>

          <button id="btnLimparGerador" class="btn-outline">
            Limpar sele√ß√£o
          </button>
        </div>

        <!-- RESET HOR√ÅRIOS -->

        <div class="card">
          <h3>Gerenciar DISPONIBILIDADE</h3>

          <button id="btnAbrirReset" class="btn-outline">
            Abrir gerenciador
          </button>

          <div id="resetBox" class="hidden">
            <label>Barbeiro</label>
            <select id="resetBarbeiro"></select>

            <h4>Dias</h4>
            <div id="resetDias"></div>

            <h4>Hor√°rios</h4>
            <div id="resetHorarios" class="grid"></div>

            <button id="btnExcluirSlots" class="btn-danger btn">
              Remover hor√°rios
            </button>
          </div>
        </div>

        <!-- AGENDA ADMIN -->

        <div class="card">
          <h3>Todos agendamentos</h3>
          <div id="listaAgendamentos"></div>
        </div>
      </div>

      <!-- ================= EXCLUS√ÉO ================= -->

      <div id="telaExclusao" class="hidden">
        <div class="card">
          <h3>Excluir agendamentos</h3>

          <label>Barbeiro</label>
          <select id="excBarbeiro"></select>

          <label>Data</label>
          <input type="date" id="excData" />

          <button id="btnCarregarExc" class="btn">Carregar</button>
        </div>

        <div class="card">
          <div id="listaExclusao"></div>
        </div>
      </div>

      <!-- ================= FIREBASE ================= -->

      <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

      <script>
        // ================= FIREBASE CONFIG =================

        const firebaseConfig = {
          apiKey: "AIzaSyBDffb23AqSOoT-8Z94Ao9leB5nTSdIv78",
          authDomain: "agenda-barbarujo.firebaseapp.com",
          databaseURL: "https://agenda-barbarujo-default-rtdb.firebaseio.com/",
          projectId: "agenda-barbarujo",
          storageBucket: "agenda-barbarujo.firebasestorage.app",
          messagingSenderId: "735138068544",
          appId: "1:735138068544:web:5a1273bd8be9ef7ab487a5",
        };

        firebase.initializeApp(firebaseConfig);

        const db = firebase.database();

        const DB = {
          servicos: db.ref("barbarujo/servicos"),
          barbeiros: db.ref("barbarujo/barbeiros"),
          config: db.ref("barbarujo/config"),
          ag: db.ref("barbarujo/agendamentos"),
          disp: db.ref("barbarujo/disponibilidade"),
          vendas: db.ref("barbarujo/vendas"),
        };

        // ================= ESTADO GLOBAL =================

        let servicos = [];
        let barbeiros = [];
        let disponibilidade = {};
        let agendamentos = [];
        let agendamentosMap = {};

        let servicosMulti = [];

        let barbeiroSel = null;
        let dataSel = null;
        let horaSel = null;
        let pagamentoSel = null;

        let reservando = false;

        const NOME_BARBEARIA = "BARBARUJO";
        const PIX_CHAVE = "49999538762";

        let config = { intervalo: 30 };

        // ================= HELPERS =================

        function hojeISO() {
          return new Date().toISOString().split("T")[0];
        }

        function rolarPara(el) {
          if (!el) return;
          setTimeout(() => el.scrollIntoView({ behavior: "smooth" }), 120);
        }

        function formatarPreco(v) {
          return Number(v || 0)
            .toFixed(2)
            .replace(".", ",");
        }

        function aplicarNome() {
          topo.innerText = "üíà " + NOME_BARBEARIA;
          document.title = NOME_BARBEARIA + " ‚Ä¢ Agendamento";
        }

        aplicarNome();

        // ================= RESET ESTADO =================

        function resetEscolha() {
          servicosMulti = [];
          barbeiroSel = null;
          dataSel = null;
          horaSel = null;
          pagamentoSel = null;

          cardBarbeiro.classList.add("hidden");
          cardData.classList.add("hidden");
          cardHorarios.classList.add("hidden");
          cardCliente.classList.add("hidden");
          cardServicosSel.classList.add("hidden");

          boxPagamento.classList.add("hidden");

          document
            .querySelectorAll(".pagamento-btn")
            .forEach((b) => b.classList.remove("sel"));
        }

        // ================= SPLASH ‚Üí CLIENTE =================

        btnEntrar.onclick = () => {
          telaSplash.style.display = "none";
          document.querySelector(".container").style.display = "block";

          telaCliente.classList.remove("hidden");
          telaAdmin.classList.add("hidden");
          telaBarbeiro.classList.add("hidden");
          telaExclusao.classList.add("hidden");

          btnBack.classList.remove("hidden");

          resetEscolha();
        };

        // ================= SPLASH ‚Üí BARBEIRO =================

        btnModoBarbeiro.onclick = () => {
          let s = prompt("Senha barbeiro");

          if (s !== "barbeiro123") {
            alert("Senha incorreta");
            return;
          }

          telaSplash.style.display = "none";
          document.querySelector(".container").style.display = "block";

          telaCliente.classList.add("hidden");
          telaAdmin.classList.add("hidden");
          telaExclusao.classList.add("hidden");
          telaBarbeiro.classList.remove("hidden");

          btnBack.classList.remove("hidden");

          popularModoBarbeiro();
        };

        // ================= ADMIN LOGIN =================

        btnAdminFab.onclick = () => {
          let s = prompt("Senha admin");

          if (s !== "barbarujo123") {
            if (s !== null) alert("Senha incorreta");
            return;
          }

          telaSplash.style.display = "none";
          document.querySelector(".container").style.display = "block";

          telaCliente.classList.add("hidden");
          telaBarbeiro.classList.add("hidden");
          telaExclusao.classList.add("hidden");
          telaAdmin.classList.remove("hidden");

          btnBack.classList.remove("hidden");
        };

        // ================= BACK =================

        btnBack.onclick = () => {
          if (!telaExclusao.classList.contains("hidden")) {
            telaExclusao.classList.add("hidden");
            telaAdmin.classList.remove("hidden");
            return;
          }

          if (!telaAdmin.classList.contains("hidden")) {
            telaAdmin.classList.add("hidden");
            telaCliente.classList.remove("hidden");
            return;
          }

          if (!telaBarbeiro.classList.contains("hidden")) {
            telaBarbeiro.classList.add("hidden");
            telaCliente.classList.remove("hidden");
            return;
          }

          document.querySelector(".container").style.display = "none";
          telaSplash.style.display = "flex";
          btnBack.classList.add("hidden");
        };

        // ================= TELEFONE INPUT =================

        clienteFone.addEventListener("input", () => {
          clienteFone.value = clienteFone.value.replace(/\D/g, "").slice(0, 11);
        });

        // ================= PIX COPY =================

        btnCopiarPix.onclick = () => {
          navigator.clipboard.writeText(PIX_CHAVE);
          alert("Chave PIX copiada");
        };

        btnCopiarPixConfirm.onclick = () => {
          navigator.clipboard.writeText(PIX_CHAVE);
          alert("Chave PIX copiada");
        };

        btnVoltarPagamento.onclick = () => {
          telaConfirmaPix.classList.add("hidden");
          cardCliente.classList.remove("hidden");
          rolarPara(cardCliente);
        };

        // ================= PAGAMENTO UI =================

        function ativarPagamentoUI(total) {
          boxPagamento.classList.remove("hidden");
          pixValorView.innerText = formatarPreco(total);

          document.querySelectorAll(".pagamento-btn").forEach((btn) => {
            btn.onclick = () => {
              document
                .querySelectorAll(".pagamento-btn")
                .forEach((b) => b.classList.remove("sel"));

              btn.classList.add("sel");
              pagamentoSel = btn.dataset.pg;

              if (pagamentoSel === "pix") {
                pixInfo.classList.remove("hidden");
              } else {
                pixInfo.classList.add("hidden");
              }
            };
          });
        }
        // =====================================================
        // ================= SERVI√áOS CLIENTE ==================
        // =====================================================

        function renderServicos() {
          listaServicos.innerHTML = "";

          if (!servicos.length) {
            listaServicos.innerHTML = "Sem servi√ßos cadastrados";
            return;
          }

          servicos.forEach((s) => {
            let b = document.createElement("button");
            b.className = "btn";

            b.innerHTML = `
<div style="font-size:16px;font-weight:800">
${s.nome}
</div>
<div class="price">
R$ ${formatarPreco(s.preco)}
</div>
`;

            b.onclick = () => {
              if (!servicosMulti.find((x) => x.nome === s.nome)) {
                servicosMulti.push(s);
              }

              renderServicosSelecionados();

              cardBarbeiro.classList.remove("hidden");
              renderBarbeiros();
              rolarPara(cardServicosSel);
            };

            listaServicos.appendChild(b);
          });
        }

        // ================= LISTA SERVI√áOS SELECIONADOS =================

        function renderServicosSelecionados() {
          listaServicosSel.innerHTML = "";

          if (!servicosMulti.length) {
            cardServicosSel.classList.add("hidden");
            return;
          }

          cardServicosSel.classList.remove("hidden");

          servicosMulti.forEach((s, i) => {
            let div = document.createElement("div");
            div.className = "card-sub";
            div.style.padding = "12px";
            div.style.marginBottom = "10px";

            div.innerHTML = `
<b>${s.nome}</b><br>
R$ ${formatarPreco(s.preco)}
<button class="btn-danger btn"
style="margin-top:8px"
onclick="removerServicoSel(${i})">
Remover
</button>
`;

            listaServicosSel.appendChild(div);
          });

          atualizarResumo();
        }

        function removerServicoSel(i) {
          servicosMulti.splice(i, 1);
          renderServicosSelecionados();
        }

        btnLimparServicos.onclick = () => {
          servicosMulti = [];
          renderServicosSelecionados();
        };

        // =====================================================
        // ================= BARBEIROS =========================
        // =====================================================

        function renderBarbeiros() {
          listaBarbeiros.innerHTML = "";

          if (!barbeiros.length) {
            listaBarbeiros.innerHTML = "Sem barbeiros";
            return;
          }

          barbeiros.forEach((b) => {
            let nome = b.nome || b;

            let btn = document.createElement("button");
            btn.className = "btn-outline";
            btn.innerText = nome;

            btn.onclick = () => {
              barbeiroSel = nome;

              cardData.classList.remove("hidden");
              renderDatasCliente();
              rolarPara(cardData);
            };

            listaBarbeiros.appendChild(btn);
          });
        }

        // =====================================================
        // ================= DATAS CLIENTE =====================
        // =====================================================

        function renderDatasCliente() {
          dataEscolhida.innerHTML = "";

          let diasObj = disponibilidade[barbeiroSel] || {};
          let dias = Object.keys(diasObj).sort();

          let hoje = hojeISO();

          dias = dias.filter((d) => d >= hoje);

          if (!dias.length) {
            let o = document.createElement("option");
            o.textContent = "Sem dias dispon√≠veis";
            dataEscolhida.appendChild(o);
            return;
          }

          dias.forEach((d) => {
            let o = document.createElement("option");
            o.value = d;
            o.textContent = d;
            dataEscolhida.appendChild(o);
          });
        }

        // =====================================================
        // ================= CONFIRMAR DATA ====================
        // =====================================================

        btnConfirmarData.onclick = () => {
          dataSel = dataEscolhida.value;

          if (!dataSel) {
            alert("Escolha um dia");
            return;
          }

          cardHorarios.classList.remove("hidden");
          renderHorariosCliente();
          rolarPara(cardHorarios);
        };

        function renderHorariosCliente() {
          listaHorarios.innerHTML = "";
          horaSel = null;

          let lista =
            (disponibilidade[barbeiroSel] &&
              disponibilidade[barbeiroSel][dataSel]) ||
            [];

          if (!lista.length) {
            listaHorarios.innerHTML = "Sem hor√°rios";
            return;
          }

          lista.forEach((hora) => {
            let div = document.createElement("div");
            div.className = "slot";
            div.innerText = hora;

            let ocupado = agendamentos.find(
              (a) =>
                a.data === dataSel &&
                a.hora === hora &&
                a.barbeiro === barbeiroSel,
            );

            if (ocupado) {
              div.classList.add("booked");
            }

            div.onclick = () => {
              if (div.classList.contains("booked")) return;

              document
                .querySelectorAll("#listaHorarios .slot")
                .forEach((s) => s.classList.remove("selected"));

              div.classList.add("selected");

              horaSel = hora;

              cardCliente.classList.remove("hidden");
              atualizarResumo();

              let total = totalServicos();
              ativarPagamentoUI(total);

              rolarPara(cardCliente);
            };

            listaHorarios.appendChild(div);
          });
        }

        // =====================================================
        // ================= TOTAL + RESUMO ====================
        // =====================================================

        function totalServicos() {
          return servicosMulti.reduce((t, s) => t + Number(s.preco || 0), 0);
        }

        function nomesServicos() {
          return servicosMulti.map((s) => s.nome).join(", ");
        }

        function atualizarResumo() {
          if (!horaSel) return;

          let total = totalServicos();

          resumoEscolha.innerHTML = `
<div class="card-sub" style="padding:16px">
<b>Servi√ßos:</b> ${nomesServicos()}<br>
<b>Barbeiro:</b> ${barbeiroSel}<br>
<b>Data:</b> ${dataSel}<br>
<b>Hora:</b> ${horaSel}<br>
<div class="price" style="margin-top:10px">
R$ ${formatarPreco(total)}
</div>
</div>
`;

          pixValorView.innerText = formatarPreco(total);
        }
        // =====================================================
        // ================= WHATSAPP LOJA =====================
        // =====================================================

        function enviarWhatsLoja(ag) {
          let msg = `üíà ${NOME_BARBEARIA}

Novo agendamento:

Cliente: ${ag.cliente}
Whats: ${ag.fone}
Servi√ßos: ${ag.servico}
Barbeiro: ${ag.barbeiro}
Data: ${ag.data}
Hora: ${ag.hora}
Pagamento: ${ag.pagamento}
Valor: R$ ${formatarPreco(ag.preco)}
`;

          let url =
            "https://wa.me/5549999538762?text=" + encodeURIComponent(msg);

          // redireciona ‚Äî n√£o √© popup ‚Üí n√£o bloqueia
          window.location.href = url;
        }

        // =====================================================
        // ================= REGISTRAR VENDA ===================
        // =====================================================

        function registrarVenda(ag, estorno = false) {
          let dia = ag.data;
          let forma = ag.pagamento;
          let valor = Number(ag.preco || 0);
          if (estorno) valor = -valor;
          DB.vendas
            .child(dia)
            .child(forma)
            .transaction((v) => (v || 0) + valor);
        }

        // =====================================================
        // ================= RESERVAR ==========================
        // =====================================================

        btnReservar.onclick = async () => {
          if (reservando) return;
          if (!servicosMulti.length) {
            alert("Escolha ao menos um servi√ßo");
            return;
          }
          if (!barbeiroSel || !dataSel || !horaSel) {
            alert("Complete as escolhas");
            return;
          }
          if (!clienteNome.value || clienteNome.value.length < 2) {
            alert("Digite o nome");
            return;
          }
          if (clienteFone.value.length < 10) {
            alert("WhatsApp inv√°lido");
            return;
          }
          if (!pagamentoSel) {
            alert("Escolha a forma de pagamento");
            return;
          }

          if (pagamentoSel === "pix") {
            cardCliente.classList.add("hidden");
            telaConfirmaPix.classList.remove("hidden");
            pixValorConfirm.innerText = formatarPreco(totalServicos());
            rolarPara(telaConfirmaPix);
            return;
          }

          executarReserva();
        };

        btnJaFizPix.onclick = () => {
          executarReserva();
        };

        async function executarReserva() {
          if (reservando) return;
          reservando = true;
          const btnAcao = pagamentoSel === "pix" ? btnJaFizPix : btnReservar;
          btnAcao.innerText = "Verificando...";
          btnAcao.disabled = true;

          try {
            // TRAVA ANTI DUPLA RESERVA
            let snap = await DB.ag
              .orderByChild("data")
              .equalTo(dataSel)
              .once("value");
            let ags = snap.val() || {};
            let ocupado = Object.values(ags).find(
              (a) => a.hora === horaSel && a.barbeiro === barbeiroSel,
            );

            if (ocupado) {
              alert("Este hor√°rio j√° foi reservado. Escolha outro.");
              reservando = false;
              btnAcao.innerText =
                pagamentoSel === "pix"
                  ? "J√° realizei o pagamento"
                  : "Reservar hor√°rio";
              btnAcao.disabled = false;
              renderHorariosCliente();
              if (pagamentoSel === "pix") {
                telaConfirmaPix.classList.add("hidden");
                cardHorarios.classList.remove("hidden");
              }
              return;
            }

            let total = totalServicos();
            let ag = {
              servico: nomesServicos(),
              preco: total,
              barbeiro: barbeiroSel,
              data: dataSel,
              hora: horaSel,
              cliente: clienteNome.value,
              fone: clienteFone.value,
              pagamento: pagamentoSel,
              ts: Date.now(),
            };

            await DB.ag.push(ag);
            registrarVenda(ag);
            enviarWhatsLoja(ag);
          } catch (e) {
            alert("Erro ao salvar agendamento");
            reservando = false;
            btnAcao.innerText =
              pagamentoSel === "pix"
                ? "J√° realizei o pagamento"
                : "Reservar hor√°rio";
            btnAcao.disabled = false;
          }
        }

        // =====================================================
        // ================= ADMIN SERVI√áOS ====================
        // =====================================================

        function renderAdminServicos() {
          adminServicos.innerHTML = "";

          if (!servicos.length) {
            adminServicos.innerHTML = "Sem servi√ßos";
            return;
          }

          servicos.forEach((s, i) => {
            let div = document.createElement("div");
            div.className = "card card-sub";

            div.innerHTML = `
<b>${s.nome}</b><br>
<div class="price">R$ ${formatarPreco(s.preco)}</div>

<button class="btn-danger btn"
style="margin-top:10px"
onclick="removerServicoAdmin(${i})">
Excluir
</button>
`;

            adminServicos.appendChild(div);
          });
        }

        btnAddServico.onclick = () => {
          if (!novoServicoNome.value || !novoServicoPreco.value) {
            alert("Preencha nome e pre√ßo");
            return;
          }

          servicos.push({
            nome: novoServicoNome.value,
            preco: Number(novoServicoPreco.value),
          });

          DB.servicos.set(servicos);

          novoServicoNome.value = "";
          novoServicoPreco.value = "";
        };

        // =====================================================
        // ================= ADMIN BARBEIROS ===================
        // =====================================================

        function renderAdminBarbeiros() {
          adminBarbeiros.innerHTML = "";

          barbeiros.forEach((b, i) => {
            let nome = b.nome || b;
            let whats = b.whats || "";

            let div = document.createElement("div");
            div.className = "card card-sub";

            div.innerHTML = `
<b>${nome}</b><br>
Whats: ${whats || "-"}

<input id="wb_${i}" placeholder="Whats barbeiro">

<button class="btn-dark btn"
style="margin-top:8px"
onclick="salvarWhatsBarbeiro(${i})">
Salvar Whats
</button>

<button class="btn-danger btn"
style="margin-top:8px"
onclick="removerBarbeiroAdmin(${i})">
Excluir
</button>
`;

            adminBarbeiros.appendChild(div);
          });
        }

        btnAddBarbeiro.onclick = () => {
          if (!novoBarbeiro.value) {
            alert("Digite o nome");
            return;
          }

          barbeiros.push({
            nome: novoBarbeiro.value,
            whats: "",
          });

          DB.barbeiros.set(barbeiros);
          novoBarbeiro.value = "";
        };

        function salvarWhatsBarbeiro(i) {
          let v = document.getElementById("wb_" + i).value.replace(/\D/g, "");

          if (v.length < 10) {
            alert("Whats inv√°lido");
            return;
          }

          barbeiros[i].whats = v;
          DB.barbeiros.set(barbeiros);
        }

        function removerBarbeiroAdmin(i) {
          if (!confirm("Excluir barbeiro?")) return;
          barbeiros.splice(i, 1);
          DB.barbeiros.set(barbeiros);
        }

        function removerServicoAdmin(i) {
          if (!confirm("Excluir servi√ßo?")) return;
          servicos.splice(i, 1);
          DB.servicos.set(servicos);
        }
        // =====================================================
        // ============ POPULAR SELECTS BARBEIRO ===============
        // =====================================================

        function popularSelectsBarbeiro() {
          adminBarbeiroSel.innerHTML = "";
          resetBarbeiro.innerHTML = "";
          barbeiroModoSel.innerHTML = "";
          excBarbeiro.innerHTML = "";

          barbeiros.forEach((b) => {
            let nome = b.nome || b;

            adminBarbeiroSel.add(new Option(nome, nome));
            resetBarbeiro.add(new Option(nome, nome));
            barbeiroModoSel.add(new Option(nome, nome));
            excBarbeiro.add(new Option(nome, nome));
          });
        }

        // =====================================================
        // ================= HOR√ÅRIOS BASE =====================
        // =====================================================
        // SEG‚ÄìSEX: 09‚Äì12 / 14‚Äì19
        // S√ÅBADO: 09‚Äì17
        // DOMINGO: fechado

        function blocosDiaSemana(dataISO) {
          let d = new Date(dataISO + "T00:00:00");
          let dia = d.getDay();

          if (dia === 0) return [];

          if (dia === 6) {
            return [["09:00", "17:00"]];
          }

          return [
            ["09:00", "12:00"],
            ["14:00", "19:00"],
          ];
        }

        // =====================================================
        // ================= GERAR SLOTS =======================
        // =====================================================

        function gerarSlotsFixos(dataISO) {
          let blocos = blocosDiaSemana(dataISO);
          let lista = [];
          let intervalo = config.intervalo || 30;

          blocos.forEach((b) => {
            let [ai, af] = b;

            let [ha, ma] = ai.split(":").map(Number);
            let [hf, mf] = af.split(":").map(Number);

            let ini = ha * 60 + ma;
            let fim = hf * 60 + mf;

            for (let t = ini; t < fim; t += intervalo) {
              let h = Math.floor(t / 60)
                .toString()
                .padStart(2, "0");
              let m = (t % 60).toString().padStart(2, "0");

              lista.push(h + ":" + m);
            }
          });

          return lista;
        }

        // =====================================================
        // =============== GERAR SLOTS ADMIN ===================
        // =====================================================

        btnGerarSlots.onclick = () => {
          let barbeiro = adminBarbeiroSel.value;
          let data = adminDataPick.value;

          if (!barbeiro || !data) {
            alert("Escolha barbeiro e data");
            return;
          }

          let base = gerarSlotsFixos(data);

          adminSlotsGrid.innerHTML = "";

          if (!base.length) {
            adminSlotsGrid.innerHTML = "Domingo fechado";
            return;
          }

          let ja =
            (disponibilidade[barbeiro] && disponibilidade[barbeiro][data]) ||
            [];

          base.forEach((hora) => {
            let div = document.createElement("div");
            div.className = "slot";
            div.innerText = hora;

            if (ja.includes(hora)) {
              div.classList.add("selected");
            }

            div.onclick = () => div.classList.toggle("selected");

            adminSlotsGrid.appendChild(div);
          });

          rolarPara(adminSlotsGrid);
        };

        // =====================================================
        // ============== SALVAR DISPONIBILIDADE ===============
        // =====================================================

        btnSalvarSlotsDia.onclick = () => {
          let barbeiro = adminBarbeiroSel.value;
          let data = adminDataPick.value;

          if (!barbeiro || !data) {
            alert("Escolha barbeiro e data");
            return;
          }

          let sel = [];

          document
            .querySelectorAll("#adminSlotsGrid .slot.selected")
            .forEach((s) => sel.push(s.innerText));

          if (!sel.length) {
            alert("Selecione hor√°rios");
            return;
          }

          DB.disp.child(barbeiro).child(data).set(sel);

          alert("Disponibilidade salva");

          adminSlotsGrid.innerHTML = "";
          adminDataPick.value = "";
        };

        // =====================================================
        // ================= LIMPAR GERADOR ====================
        // =====================================================

        btnLimparGerador.onclick = () => {
          adminSlotsGrid.innerHTML = "";
        };

        // =====================================================
        // ================= RESET GUIADO ======================
        // =====================================================

        btnAbrirReset.onclick = () => {
          resetBox.classList.toggle("hidden");

          if (!resetBox.classList.contains("hidden")) {
            renderResetDias();
            rolarPara(resetBox);
          }
        };

        resetBarbeiro.onchange = renderResetDias;

        function renderResetDias() {
          resetDias.innerHTML = "";
          resetHorarios.innerHTML = "";

          let barbeiro = resetBarbeiro.value;

          if (!barbeiro) {
            resetDias.innerHTML = "Escolha o barbeiro";
            return;
          }

          let diasObj = disponibilidade[barbeiro] || {};
          let dias = Object.keys(diasObj).sort();

          if (!dias.length) {
            resetDias.innerHTML = "Sem dias";
            return;
          }

          dias.forEach((d) => {
            let b = document.createElement("button");
            b.className = "btn-dark btn";
            b.style.marginBottom = "8px";
            b.textContent = d;

            b.onclick = () => renderResetHorarios(barbeiro, d);

            resetDias.appendChild(b);
          });
        }

        // -----------------------------------------------------

        function renderResetHorarios(barbeiro, data) {
          resetHorarios.innerHTML = "";

          let lista =
            (disponibilidade[barbeiro] && disponibilidade[barbeiro][data]) ||
            [];

          if (!lista.length) {
            resetHorarios.innerHTML = "Sem hor√°rios";
            return;
          }

          lista.forEach((h) => {
            let div = document.createElement("div");
            div.className = "slot";
            div.innerText = h;
            div.onclick = () => div.classList.toggle("selected");

            resetHorarios.appendChild(div);
          });

          resetHorarios.dataset.barbeiro = barbeiro;
          resetHorarios.dataset.data = data;

          rolarPara(resetHorarios);
        }

        // =====================================================
        // ================= EXCLUIR SLOTS =====================
        // =====================================================

        btnExcluirSlots.onclick = () => {
          let barbeiro = resetHorarios.dataset.barbeiro;
          let data = resetHorarios.dataset.data;

          if (!barbeiro || !data) {
            alert("Escolha barbeiro e dia");
            return;
          }

          let remover = [];

          document
            .querySelectorAll("#resetHorarios .slot.selected")
            .forEach((s) => remover.push(s.innerText));

          if (!remover.length) {
            alert("Selecione hor√°rios");
            return;
          }

          if (!confirm("Remover hor√°rios?")) return;

          let atuais =
            (disponibilidade[barbeiro] && disponibilidade[barbeiro][data]) ||
            [];

          let novos = atuais.filter((h) => !remover.includes(h));

          DB.disp.child(barbeiro).child(data).set(novos);

          alert("Hor√°rios removidos");

          renderResetHorarios(barbeiro, data);
        };
        // =====================================================
        // ================= ADMIN AGENDA ======================
        // =====================================================

        function renderAdminAgendamentos() {
          listaAgendamentos.innerHTML = "";

          let lista = Object.entries(agendamentosMap);

          if (!lista.length) {
            listaAgendamentos.innerHTML = "Sem agendamentos";
            return;
          }

          lista
            .sort((a, b) =>
              (a[1].data + a[1].hora).localeCompare(b[1].data + b[1].hora),
            )
            .forEach(([key, a]) => {
              let div = document.createElement("div");
              div.className = "card card-sub";

              div.innerHTML = `
<b>${a.data} ‚Ä¢ ${a.hora}</b><br>
Cliente: ${a.cliente}<br>
Servi√ßos: ${a.servico}<br>
Barbeiro: ${a.barbeiro}<br>
Pagamento: ${a.pagamento || "-"}<br>
<div class="price">R$ ${formatarPreco(a.preco)}</div>

<button class="btn-danger btn"
style="margin-top:10px"
onclick="excluirAgendamentoAdmin('${key}')">
Excluir
</button>
`;

              listaAgendamentos.appendChild(div);
            });
        }

        function excluirAgendamentoAdmin(key) {
          if (!confirm("Excluir agendamento?")) return;
          let ag = agendamentosMap[key];
          if (ag) {
            registrarVenda(ag, true); // Refund
          }
          DB.ag.child(key).remove();
        }

        // =====================================================
        // ================= TELA EXCLUS√ÉO =====================
        // =====================================================

        btnCarregarExc.onclick = () => {
          let barb = excBarbeiro.value;
          let data = excData.value;

          if (!barb || !data) {
            alert("Escolha barbeiro e data");
            return;
          }

          listaExclusao.innerHTML = "";

          let lista = Object.entries(agendamentosMap)
            .filter(([k, a]) => a.barbeiro === barb && a.data === data)
            .sort((a, b) => a[1].hora.localeCompare(b[1].hora));

          if (!lista.length) {
            listaExclusao.innerHTML = "Nenhum agendamento";
            return;
          }

          lista.forEach(([key, a]) => {
            let div = document.createElement("div");
            div.className = "card card-sub";

            div.innerHTML = `
<b>${a.hora}</b><br>
${a.cliente}<br>
${a.servico}

<button class="btn-danger btn"
style="margin-top:8px"
onclick="excluirAgendamentoAdmin('${key}')">
Excluir
</button>
`;

            listaExclusao.appendChild(div);
          });
        };

        // =====================================================
        // ================= MODO BARBEIRO =====================
        // =====================================================

        btnVerAgendaBarbeiro.onclick = renderAgendaBarbeiro;

        function popularModoBarbeiro() {
          barbeiroModoSel.innerHTML = "";
          barbeiros.forEach((b) => {
            let nome = b.nome || b;
            barbeiroModoSel.add(new Option(nome, nome));
          });
        }

        function renderAgendaBarbeiro() {
          let nome = barbeiroModoSel.value;
          let data = barbeiroModoData.value || hojeISO();

          listaBarbeiroAgenda.innerHTML = "";

          let lista = agendamentos
            .filter((a) => a.barbeiro === nome && a.data === data)
            .sort((a, b) => a.hora.localeCompare(b.hora));

          if (!lista.length) {
            listaBarbeiroAgenda.innerHTML = "Sem clientes";
            return;
          }

          lista.forEach((a) => {
            let div = document.createElement("div");
            div.className = "card card-sub";

            div.innerHTML = `
<b>${a.hora}</b><br>
${a.cliente}<br>
${a.servico}<br>

<button class="btn-dark btn"
onclick="window.open('https://wa.me/55${a.fone}')">
WhatsApp
</button>

<button class="btn-outline"
onclick="copiarFone('${a.fone}')">
Copiar telefone
</button>

<button class="btn"
onclick="enviarLembreteCliente(
'${a.cliente}',
'${a.fone}',
'${a.data}',
'${a.hora}',
'${a.servico}'
)">
Lembrete
</button>
`;

            listaBarbeiroAgenda.appendChild(div);
          });
        }

        function copiarFone(f) {
          navigator.clipboard.writeText(f);
          alert("Telefone copiado");
        }

        function enviarLembreteCliente(nome, fone, data, hora, servico) {
          let msg = `üíà ${NOME_BARBEARIA}

Ol√° ${nome}!
Lembrete do seu hor√°rio:

Servi√ßo: ${servico}
Data: ${data}
Hora: ${hora}
`;

          let url =
            "https://wa.me/55" +
            fone.replace(/\D/g, "") +
            "?text=" +
            encodeURIComponent(msg);

          window.open(url, "_blank");
        }

        // =====================================================
        // ================= RELAT√ìRIO HOJE ====================
        // =====================================================

        function renderRelHoje() {
          let hoje = hojeISO();

          let lista = agendamentos.filter((a) => a.data === hoje);

          let total = 0;
          let porTipo = { pix: 0, debito: 0, credito: 0, dinheiro: 0 };

          lista.forEach((a) => {
            let v = Number(a.preco || 0);
            total += v;
            if (porTipo[a.pagamento] != null) {
              porTipo[a.pagamento] += v;
            }
          });

          relHojeBox.classList.remove("hidden");
          relPeriodoBox.classList.add("hidden");

          relHojeBox.innerHTML = `
<b>Hoje ‚Äî ${hoje}</b><br><br>
PIX: R$ ${formatarPreco(porTipo.pix)}<br>
D√©bito: R$ ${formatarPreco(porTipo.debito)}<br>
Cr√©dito: R$ ${formatarPreco(porTipo.credito)}<br>
Dinheiro: R$ ${formatarPreco(porTipo.dinheiro)}<br><br>
<div class="price">
Total: R$ ${formatarPreco(total)}
</div>
`;
        }

        btnRelHoje.onclick = renderRelHoje;

        btnZerarVendas.onclick = () => {
          if (
            confirm(
              "ATEN√á√ÉO: Isso apagar√° TODOS os dados de vendas permanentemente. Voc√™ tem certeza absoluta?"
            )
          ) {
            if (
              confirm(
                "√öLTIMA CHANCE: Confirmar exclus√£o total de relat√≥rios de vendas?"
              )
            ) {
              DB.vendas.remove().then(() => {
                alert("Relat√≥rios zerados com sucesso.");
                relHojeBox.classList.add("hidden");
                relPeriodoBox.classList.add("hidden");
              });
            }
          }
        };

        // =====================================================
        // ================= RELAT√ìRIO PER√çODO =================
        // =====================================================

        btnRelPeriodo.onclick = () => {
          relHojeBox.classList.add("hidden");
          relPeriodoBox.classList.remove("hidden");

          relPeriodoBox.innerHTML = `
<select id="relTipoSel">
<option value="dia">Dia</option>
<option value="mes">M√™s</option>
<option value="ano">Ano</option>
</select>
<div id="relInputContainer" style="margin-top:10px">
<input type="date" id="relRefDia">
</div>
<button id="btnGerarRel" class="btn" style="margin-top:10px"> Gerar </button>
<div id="relOut" style="margin-top:12px"></div>
`;

          const relTipoSel = document.getElementById("relTipoSel");
          const relInputContainer =
            document.getElementById("relInputContainer");

          relTipoSel.onchange = () => {
            const tipo = relTipoSel.value;
            if (tipo === "dia") {
              relInputContainer.innerHTML = `<input type="date" id="relRefDia" style="width:100%; padding:16px; border-radius:14px; border:none; margin-top:8px; margin-bottom:14px; color:#000; font-size:15px;">`;
            } else if (tipo === "mes") {
              relInputContainer.innerHTML = `<input type="month" id="relRefDia" style="width:100%; padding:16px; border-radius:14px; border:none; margin-top:8px; margin-bottom:14px; color:#000; font-size:15px;">`;
            } else if (tipo === "ano") {
              const anos = [
                ...new Set(agendamentos.map((a) => a.data.split("-")[0])),
              ]
                .sort()
                .reverse();
              if (anos.length === 0) {
                const anoAtual = new Date().getFullYear();
                anos.push(anoAtual.toString());
              }
              let options = anos
                .map((a) => `<option value="${a}">${a}</option>`)
                .join("");
              relInputContainer.innerHTML = `<select id="relRefDia" style="width:100%; padding:16px; border-radius:14px; border:none; margin-top:8px; margin-bottom:14px; color:#000; font-size:15px;">${options}</select>`;
            }
          };

          document.getElementById("btnGerarRel").onclick = () => {
            let d = document.getElementById("relRefDia").value;
            let tipo = relTipoSel.value;
            if (!d) return;

            let refParts = d.split("-"); // [YYYY, MM, DD] ou [YYYY, MM] ou [YYYY]
            let lista = agendamentos.filter((a) => {
              let aParts = a.data.split("-");
              if (tipo === "dia") return a.data === d;
              if (tipo === "mes")
                return aParts[0] === refParts[0] && aParts[1] === refParts[1];
              if (tipo === "ano") return aParts[0] === d; // No select do ano, o value √© o ano
              return false;
            });

            let total = lista.reduce((t, a) => t + Number(a.preco || 0), 0);
            document.getElementById("relOut").innerHTML =
              `Total: <b>R$ ${formatarPreco(total)}</b>`;
          };
        };

        // =====================================================
        // ================= SYNC FIREBASE =====================
        // =====================================================

        DB.servicos.on("value", (snap) => {
          if (snap.exists()) {
            servicos = Object.values(snap.val());
          } else {
            DB.servicos.set([
              { nome: "Corte", preco: 40 },
              { nome: "Barba", preco: 30 },
            ]);
            return;
          }

          renderServicos();
          renderAdminServicos();
        });

        DB.barbeiros.on("value", (snap) => {
          if (snap.exists()) {
            barbeiros = Object.values(snap.val());
          } else {
            DB.barbeiros.set([{ nome: "Carlos" }]);
            return;
          }

          renderBarbeiros();
          renderAdminBarbeiros();
          popularSelectsBarbeiro();
          popularModoBarbeiro();
        });

        DB.disp.on("value", (snap) => {
          disponibilidade = snap.exists() ? snap.val() : {};
          if (barbeiroSel) renderDatasCliente();
          renderResetDias();
        });

        DB.ag.on("value", (snap) => {
          agendamentosMap = snap.exists() ? snap.val() : {};
          agendamentos = Object.values(agendamentosMap);
          renderAdminAgendamentos();
          if (barbeiroSel && dataSel) renderHorariosCliente();
          if (!telaBarbeiro.classList.contains("hidden")) {
            renderAgendaBarbeiro();
          }
        });

        DB.config.on("value", (snap) => {
          if (snap.exists()) {
            config = snap.val();
          }
        });
      </script>
    </div>
  </body>
</html>
